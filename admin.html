<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Singbox - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@600;700;800&family=Montserrat:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  >

  <style>
    :root{
      --sb-bg-main:#020617;
      --sb-bg-card:#020617;
      --sb-border-soft: rgba(148,163,184,0.35);
      --sb-text-main:#F9FAFB;
      --sb-text-muted:#9CA3AF;
      --sb-accent:#C94C35;
      --sb-accent-2:#F97316;
      --sb-container-width:1100px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Montserrat",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at 0 0, rgba(201,76,53,0.4), transparent 55%), #020617;
      color:var(--sb-text-main);
      min-height:100vh;
    }
    h1,h2,h3{
      font-family:"League Spartan",system-ui,sans-serif;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin:0;
    }
    a{color:inherit;text-decoration:none}

    .admin-container{
      max-width:var(--sb-container-width);
      margin:0 auto;
      padding:2.5rem 1.5rem 3rem;
    }
    .admin-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:2rem;
      gap:1rem;
      flex-wrap:wrap;
    }
    .admin-header-left{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .admin-logo{
      width:56px;height:56px;border-radius:999px;object-fit:cover;
      box-shadow:0 0 0 2px rgba(249,250,251,0.12), 0 16px 40px rgba(0,0,0,0.9);
    }
    .admin-title-main{font-size:20px}
    .admin-subtitle{font-size:13px;color:var(--sb-text-muted);margin-top:4px}
    .admin-header-right{
      display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;justify-content:flex-end;
    }
    .admin-header-right button{
      border-radius:999px;border:1px solid rgba(148,163,184,0.6);
      background:transparent;color:#E5E7EB;font-size:12px;padding:.4rem .9rem;cursor:pointer;
    }
    .deposit-badge{
      border-radius:999px;border:1px solid rgba(248,250,251,0.2);
      padding:.25rem .7rem;font-size:11px;text-transform:uppercase;letter-spacing:.07em;
      background: radial-gradient(circle at 0 0, rgba(249,115,22,0.45), transparent 55%), #020617;
      color:#FED7AA;white-space:nowrap;
    }

    /* LOGIN */
    #login-screen{
      display:flex;
      min-height:100vh;
      align-items:center;
      justify-content:center;
      padding:2rem 1.5rem;
    }
    #login-card{
      max-width:420px;width:100%;
      background: radial-gradient(circle at 0 0, rgba(201,76,53,0.4), transparent 55%), #020617;
      border-radius:20px;
      padding:1.8rem 1.8rem 1.6rem;
      box-shadow:0 22px 60px rgba(0,0,0,0.9);
      border:1px solid rgba(148,163,184,0.5);
    }
    #login-card h1{font-size:18px;margin-bottom:.6rem}
    #login-card p{font-size:13px;color:var(--sb-text-muted);margin-bottom:1.2rem}

    .login-field{margin-bottom:1rem}
    .login-field label{display:block;font-size:12px;margin-bottom:4px}
    .login-field input{
      width:100%;
      padding:.55rem .8rem;
      border-radius:999px;
      border:1px solid var(--sb-border-soft);
      background:#020617;
      color:var(--sb-text-main);
      font-size:13px;
      outline:none;
    }
    .login-actions{display:flex;justify-content:flex-end;align-items:center;gap:.6rem;margin-top:.3rem}
    .btn-primary{
      border-radius:999px;border:none;
      padding:.6rem 1.4rem;
      background:linear-gradient(90deg, var(--sb-accent), var(--sb-accent-2));
      color:#F9FAFB;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 0 0 1px rgba(248,250,251,0.1), 0 16px 40px rgba(0,0,0,0.9);
    }
    .status-message{font-size:12px;margin-top:.4rem;min-height:1.2em}
    .status-message.ok{color:#4ade80}
    .status-message.error{color:#f97373}

    /* ADMIN */
    #admin-screen{display:none}
    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      border-bottom:1px solid rgba(31,41,55,0.9);
      margin-bottom:1.5rem;
    }
    .tab-button{
      border-radius:999px 999px 0 0;
      border:none;padding:.5rem 1rem;
      background:transparent;
      font-size:13px;color:var(--sb-text-muted);
      cursor:pointer;
    }
    .tab-button.active{
      background: radial-gradient(circle at 0 0, rgba(201,76,53,0.4), transparent 55%), #020617;
      color:#F9FAFB;
      border-bottom:2px solid var(--sb-accent-2);
    }
    .tab-content{display:none}
    .tab-content.active{display:block}

    .card{
      background:var(--sb-bg-card);
      border-radius:18px;
      padding:1.4rem 1.5rem 1.5rem;
      box-shadow:0 22px 60px rgba(0,0,0,0.9);
      border:1px solid rgba(148,163,184,0.4);
      margin-bottom:1.6rem;
    }
    .card h2{font-size:16px;margin-bottom:.4rem}
    .card-subtitle{font-size:12px;color:var(--sb-text-muted);margin-bottom:1.1rem}

    .form-grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.75rem;margin-bottom:.75rem}
    .form-grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:.75rem;margin-bottom:.75rem}
    @media(max-width:768px){
      .form-grid-3,.form-grid-2{grid-template-columns:minmax(0,1fr)}
    }
    .form-field{font-size:12px}
    .form-field label{display:block;margin-bottom:3px}
    .form-field input,.form-field select,.form-field textarea{
      width:100%;
      padding:.45rem .7rem;
      border-radius:14px;
      border:1px solid var(--sb-border-soft);
      background:#020617;
      color:var(--sb-text-main);
      font-size:12px;
      outline:none;
    }
    .form-field textarea{min-height:160px;resize:vertical}

    .form-actions{display:flex;justify-content:flex-end;gap:.6rem;margin-top:.6rem;flex-wrap:wrap}
    .btn-secondary{
      border-radius:999px;border:1px solid rgba(148,163,184,0.6);
      padding:.55rem 1.2rem;background:transparent;color:#E5E7EB;cursor:pointer;font-size:13px;
    }

    .table-wrapper{
      border-radius:16px;border:1px solid rgba(31,41,55,0.9);
      overflow:auto;max-height:520px;
    }
    table{width:100%;border-collapse:collapse;font-size:12px;min-width:860px}
    thead{background:#020617;position:sticky;top:0;z-index:1}
    th,td{padding:.4rem .6rem;border-bottom:1px solid rgba(31,41,55,0.9);text-align:left;white-space:nowrap}
    th{text-transform:uppercase;letter-spacing:.08em;font-size:11px;color:#E5E7EB}
    .badge{
      display:inline-flex;align-items:center;
      padding:2px 6px;border-radius:999px;font-size:10px;
      text-transform:uppercase;letter-spacing:.08em;
    }
    .badge-active{background:rgba(22,163,74,.15);color:#4ade80;border:1px solid rgba(74,222,128,.6)}
    .badge-inactive{background:rgba(75,85,99,.4);color:#e5e7eb;border:1px solid rgba(148,163,184,.6)}

    .small-btn{
      border-radius:999px;border:1px solid rgba(148,163,184,0.6);
      padding:2px 8px;font-size:11px;background:transparent;color:#E5E7EB;cursor:pointer;margin-right:6px;
    }
    .small-btn.danger{border-color:rgba(248,113,113,.8);color:#fecaca}

    .helper-text{font-size:11px;color:var(--sb-text-muted);margin-top:4px}
    .kpi-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem;margin-bottom:1rem}
    .kpi-card{
      border-radius:18px;border:1px solid rgba(148,163,184,0.4);
      padding:.9rem 1rem;background: radial-gradient(circle at 0 0, rgba(148,163,184,0.15), transparent 60%), #020617;
    }
    .kpi-label{font-size:11px;text-transform:uppercase;letter-spacing:.09em;color:var(--sb-text-muted);margin-bottom:.25rem}
    .kpi-value{font-size:18px;font-weight:700}
    .kpi-sub{font-size:11px;color:var(--sb-text-muted);margin-top:.25rem}
    @media(max-width:900px){.kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:600px){.kpi-grid{grid-template-columns:minmax(0,1fr)}}

    .inline-check{
      display:flex;align-items:center;gap:10px;
      padding:.5rem .7rem;border-radius:14px;border:1px solid rgba(148,163,184,0.35);
      background:#020617;
    }
    .inline-check input{width:auto}
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="login-screen">
    <div id="login-card">
      <h1>Accès admin Singbox</h1>
      <p>Connexion sécurisée (Supabase Auth). Ton compte doit être admin côté DB.</p>

      <div class="login-field">
        <label for="admin-email">Email</label>
        <input type="email" id="admin-email" autocomplete="email" placeholder="Email admin" />
      </div>

      <div class="login-field">
        <label for="admin-password">Mot de passe</label>
        <input type="password" id="admin-password" autocomplete="current-password" />
      </div>

      <div id="login-error" class="status-message"></div>

      <div class="login-actions">
        <button id="login-button" class="btn-primary">Se connecter</button>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="admin-screen">
    <div class="admin-container">

      <header class="admin-header">
        <div class="admin-header-left">
          <img src="logo.png" alt="Logo Singbox" class="admin-logo" />
          <div>
            <h1 class="admin-title-main">Back-office Singbox</h1>
            <p class="admin-subtitle">Admin sécurisé (RLS) : actualités, codes promo, réservations.</p>
          </div>
        </div>
        <div class="admin-header-right">
          <span id="user-badge" class="deposit-badge">Connecté : --</span>
          <button id="logout-button">Se déconnecter</button>
        </div>
      </header>

      <div class="tabs">
        <button class="tab-button active" data-tab="tab-dashboard">Dashboard</button>
        <button class="tab-button" data-tab="tab-actualites">Actualités</button>
        <button class="tab-button" data-tab="tab-reservations">Réservations</button>
        <button class="tab-button" data-tab="tab-clients">Clients</button>
        <button class="tab-button" data-tab="tab-promo">Codes promo</button>
      </div>

      <!-- DASHBOARD -->
      <section id="tab-dashboard" class="tab-content active">
        <div class="card">
          <h2>Dashboard</h2>
          <p class="card-subtitle">Vue rapide du mois en cours (table <code>reservations</code>).</p>

          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-label">Réservations confirmées</div>
              <div id="kpi-resa-month" class="kpi-value">--</div>
              <div class="kpi-sub">Mois en cours</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Total réservations</div>
              <div id="kpi-resa-total" class="kpi-value">--</div>
              <div class="kpi-sub">Mois en cours</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Taux confirmées</div>
              <div id="kpi-fill-rate" class="kpi-value">-- %</div>
              <div class="kpi-sub">Confirmées / total</div>
            </div>
          </div>

          <div id="dashboard-message" class="status-message"></div>
        </div>
      </section>

      <!-- ACTUALITES -->
      <section id="tab-actualites" class="tab-content">
        <div class="card">
          <h2>Nouvel article / édition</h2>
          <p class="card-subtitle">CRUD table <code>actualites</code>. Le slug doit être unique.</p>

          <form id="article-form">
            <div class="form-grid-2">
              <div class="form-field">
                <label for="a-titre">Titre</label>
                <input id="a-titre" type="text" required />
              </div>
              <div class="form-field">
                <label for="a-slug">Slug (URL)</label>
                <input id="a-slug" type="text" placeholder="promo-etudiants" required />
                <div class="helper-text">Sans espaces ni accents. Ex: <code>ouverture-officielle</code></div>
              </div>
            </div>

            <div class="form-grid-2">
              <div class="form-field">
                <label for="a-image">Image (URL) (optionnel)</label>
                <input id="a-image" type="url" placeholder="https://.../image.jpg" />
              </div>
              <div class="form-field">
                <label for="a-chapeau">Résumé court</label>
                <input id="a-chapeau" type="text" />
              </div>
            </div>

            <div class="form-field">
              <label for="a-contenu">Contenu</label>
              <textarea id="a-contenu" placeholder="Tu peux mettre du texte ou un peu de HTML (ex: <br>, <strong>)"></textarea>
            </div>

            <div class="form-grid-3" style="margin-top:.75rem">
              <div class="form-field">
                <label for="a-categorie">Catégorie</label>
                <select id="a-categorie">
                  <option value="coulisses-travaux">Coulisses & travaux</option>
                  <option value="nouvelles-chansons">Nouvelles chansons</option>
                  <option value="vie-lieu">Vie du lieu</option>
                  <option value="idees-soirees">Idées de soirées</option>
                  <option value="promo">Promo</option>
                </select>
              </div>

              <div class="form-field">
                <label>Article publié</label>
                <div class="inline-check">
                  <input id="a-publie" type="checkbox" />
                  <span>Visible côté site</span>
                </div>
              </div>

              <div class="form-field">
                <label for="a-datepub">Date de publication (optionnel)</label>
                <input id="a-datepub" type="datetime-local" />
                <div class="helper-text">Si vide : on met la date actuelle au moment de publier.</div>
              </div>
            </div>

            <input id="a-id" type="hidden" />

            <div class="form-actions">
              <button type="button" id="article-reset" class="btn-secondary">Réinitialiser</button>
              <button type="submit" class="btn-primary">Enregistrer l’article</button>
            </div>
          </form>

          <div id="article-form-message" class="status-message"></div>
        </div>

        <div class="card">
          <h2>Liste des articles</h2>
          <p class="card-subtitle">Gestion des articles présents dans <code>actualites</code>.</p>

          <div class="form-actions" style="justify-content:flex-end;margin-top:0">
            <button id="btn-refresh-articles" class="btn-primary" type="button">Actualiser</button>
          </div>

          <div id="articles-list-message" class="status-message"></div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Titre</th>
                  <th>Slug</th>
                  <th>Catégorie</th>
                  <th>Créé le</th>
                  <th>Publication</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="articles-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- RESERVATIONS -->
      <section id="tab-reservations" class="tab-content">
        <div class="card">
          <h2>Réservations</h2>
          <p class="card-subtitle">Lecture admin (table <code>reservations</code>).</p>

          <div class="form-grid-3">
            <div class="form-field">
              <label for="filter-res-date-from">Du</label>
              <input type="date" id="filter-res-date-from">
            </div>
            <div class="form-field">
              <label for="filter-res-date-to">Au</label>
              <input type="date" id="filter-res-date-to">
            </div>
            <div class="form-field">
              <label for="filter-res-status">Statut</label>
              <select id="filter-res-status">
                <option value="">Tous</option>
                <option value="confirmed">Confirmée</option>
                <option value="pending">En attente</option>
                <option value="cancelled">Annulée</option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button id="btn-refresh-reservations" class="btn-primary" type="button">Actualiser</button>
          </div>

          <div id="reservations-list-message" class="status-message"></div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Heure</th>
                  <th>Client</th>
                  <th>Email</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody id="reservations-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CLIENTS -->
      <section id="tab-clients" class="tab-content">
        <div class="card">
          <h2>Clients</h2>
          <p class="card-subtitle">Vue clients construite depuis <code>reservations</code> (groupé par email).</p>

          <div class="form-actions" style="justify-content:flex-end;margin-top:0">
            <button id="btn-refresh-clients" class="btn-primary" type="button">Actualiser</button>
          </div>

          <div id="clients-list-message" class="status-message"></div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Email</th>
                  <th>Nb réservations</th>
                  <th>Dernière venue</th>
                </tr>
              </thead>
              <tbody id="clients-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PROMO -->
      <section id="tab-promo" class="tab-content">
        <div class="card">
          <h2>Créer un code promo</h2>
          <p class="card-subtitle">CRUD table <code>promo_codes</code>.</p>

          <form id="promo-form">
            <div class="form-grid-3">
              <div class="form-field">
                <label for="promo-code">Code</label>
                <input type="text" id="promo-code" placeholder="OUVERTURE, NOEL25..." required />
              </div>
              <div class="form-field">
                <label for="promo-type">Type</label>
                <select id="promo-type">
                  <option value="percent">Pourcentage (%)</option>
                  <option value="fixed">Montant fixe (€)</option>
                  <option value="free">Séance gratuite</option>
                </select>
              </div>
              <div class="form-field">
                <label for="promo-value">Valeur</label>
                <input type="number" id="promo-value" placeholder="ex : 20" min="0" step="0.01" />
              </div>
            </div>

            <div class="form-grid-3">
              <div class="form-field">
                <label for="promo-valid-from">Valide du</label>
                <input type="date" id="promo-valid-from" />
              </div>
              <div class="form-field">
                <label for="promo-valid-to">Valide jusqu'au</label>
                <input type="date" id="promo-valid-to" />
              </div>
              <div class="form-field">
                <label for="promo-max-uses">Nb utilisations max (global)</label>
                <input type="number" id="promo-max-uses" placeholder="ex : 50 ou vide = illimité" min="1" />
              </div>
            </div>

            <div class="form-grid-3">
              <div class="form-field">
                <label for="promo-max-per-email">Nb utilisations max / email</label>
                <input type="number" id="promo-max-per-email" placeholder="ex : 1, 2, 10..." min="1" />
              </div>

              <div class="form-field">
                <label>
                  <input type="checkbox" id="promo-first-session" />
                  Réservé à la <strong>première session</strong>
                </label>
                <div class="helper-text">Valable si l'email n'a jamais réservé.</div>
              </div>

              <div class="form-field">
                <label for="promo-email-domain">Domaine email (optionnel)</label>
                <input type="text" id="promo-email-domain" placeholder="ex : univ-toulouse.fr" />
              </div>
            </div>

            <div class="form-grid-3">
              <div class="form-field">
                <label for="promo-note">Label interne</label>
                <input type="text" id="promo-note" placeholder="Étudiants, Ulule Duo..." />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn-primary">Créer / enregistrer</button>
            </div>
          </form>

          <div id="promo-form-message" class="status-message"></div>
        </div>

        <div class="card">
          <h2>Liste des codes promo</h2>
          <p class="card-subtitle">Activer/désactiver, supprimer.</p>

          <div class="form-actions" style="justify-content:flex-end;margin-top:0">
            <button id="btn-refresh-promo" class="btn-primary" type="button">Actualiser</button>
          </div>

          <div id="promo-list-message" class="status-message"></div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Type / Conditions</th>
                  <th>Valeur</th>
                  <th>Valide du</th>
                  <th>au</th>
                  <th>Utilisations</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="promo-table-body"></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ⚠️ OK d'exposer l'ANON KEY côté front
    const supabaseUrl = "https://sfckofydfqbllkxhxwnt.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmY2tvZnlkZnFibGxreGh4d250Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxOTA4ODQsImV4cCI6MjA3OTc2Njg4NH0.2kg7GxQBU8nArCCbJPm0JSn208izXCeiDX266FUC1lw";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

    const CATEGORY_LABELS = {
      "coulisses-travaux": "Coulisses & travaux",
      "nouvelles-chansons": "Nouvelles chansons",
      "vie-lieu": "Vie du lieu",
      "idees-soirees": "Idées de soirées",
      "promo": "Promo"
    };

    function showLogin() {
      document.getElementById("login-screen").style.display = "flex";
      document.getElementById("admin-screen").style.display = "none";
    }
    function showAdmin() {
      document.getElementById("login-screen").style.display = "none";
      document.getElementById("admin-screen").style.display = "block";
    }

    function setMsg(id, text, ok=false) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = text || "";
      el.className = "status-message" + (text ? (ok ? " ok" : " error") : "");
    }

    function toISODate(date) {
      // YYYY-MM-DD (for filters)
      const d = new Date(date);
      return d.toISOString().split("T")[0];
    }

    function formatDateFr(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString("fr-FR", { day:"2-digit", month:"2-digit", year:"numeric" });
    }

    function formatDateTimeFr(ts) {
      if (!ts) return "-";
      const d = new Date(ts);
      if (isNaN(d)) return "-";
      return d.toLocaleDateString("fr-FR") + " " + d.toLocaleTimeString("fr-FR", { hour:"2-digit", minute:"2-digit" });
    }

    // -------------------------
    // AUTH
    // -------------------------
    async function refreshAuthUI() {
      const { data } = await supabaseClient.auth.getUser();
      const user = data?.user || null;
      if (!user) {
        showLogin();
        return;
      }
      showAdmin();
      document.getElementById("user-badge").textContent = "Connecté : " + (user.email || "admin");

      // Charge tout
      await loadDashboard();
      await loadArticles();
      await loadReservations();
      await loadClients();
      await loadPromoCodes();
    }

    async function handleLogin() {
      const email = document.getElementById("admin-email").value.trim();
      const password = document.getElementById("admin-password").value;

      setMsg("login-error", "");
      if (!email || !password) {
        setMsg("login-error", "Merci de saisir email + mot de passe.", false);
        return;
      }

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        console.error(error);
        setMsg("login-error", "Connexion refusée : " + (error.message || "erreur"), false);
        return;
      }

      document.getElementById("admin-password").value = "";
      await refreshAuthUI();
    }

    async function handleLogout() {
      await supabaseClient.auth.signOut();
      showLogin();
    }

    // -------------------------
    // TABS
    // -------------------------
    function initTabs() {
      document.querySelectorAll(".tab-button").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
          btn.classList.add("active");
          const target = document.getElementById(btn.dataset.tab);
          if (target) target.classList.add("active");
        });
      });
    }

    // -------------------------
    // DASHBOARD
    // -------------------------
    async function loadDashboard() {
      const msgEl = document.getElementById("dashboard-message");
      msgEl.textContent = "Chargement du dashboard...";
      msgEl.className = "status-message";

      const kpiConfirmed = document.getElementById("kpi-resa-month");
      const kpiTotal = document.getElementById("kpi-resa-total");
      const kpiRate = document.getElementById("kpi-fill-rate");

      try {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);

        const firstDateStr = toISODate(firstDay);
        const nextDateStr = toISODate(nextMonth);

        const { data, error } = await supabaseClient
          .from("reservations")
          .select("status, date")
          .gte("date", firstDateStr)
          .lt("date", nextDateStr);

        if (error) {
          console.error(error);
          msgEl.textContent = "Erreur dashboard : " + (error.message || "");
          msgEl.classList.add("error");
          return;
        }

        const total = data?.length || 0;
        const confirmed = (data || []).filter(r => r.status === "confirmed").length;
        const rate = total > 0 ? Math.round((confirmed / total) * 100) : 0;

        if (kpiConfirmed) kpiConfirmed.textContent = confirmed;
        if (kpiTotal) kpiTotal.textContent = total;
        if (kpiRate) kpiRate.textContent = rate + " %";

        msgEl.textContent = "Dashboard mis à jour ✔";
        msgEl.classList.add("ok");
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Erreur réseau dashboard.";
        msgEl.classList.add("error");
      }
    }

    // -------------------------
    // RESERVATIONS
    // -------------------------
    async function loadReservations() {
      const tbody = document.getElementById("reservations-table-body");
      const msgEl = document.getElementById("reservations-list-message");
      if (!tbody || !msgEl) return;

      tbody.innerHTML = "";
      msgEl.textContent = "Chargement des réservations...";
      msgEl.className = "status-message";

      const dateFrom = document.getElementById("filter-res-date-from")?.value || null;
      const dateTo = document.getElementById("filter-res-date-to")?.value || null;
      const status = document.getElementById("filter-res-status")?.value || "";

      try {
        let query = supabaseClient
          .from("reservations")
          .select("date, start_time, name, email, status")
          .order("start_time", { ascending: false });

        if (dateFrom) query = query.gte("date", dateFrom);
        if (dateTo) query = query.lte("date", dateTo);
        if (status) query = query.eq("status", status);

        const { data, error } = await query;
        if (error) {
          console.error(error);
          msgEl.textContent = "Erreur chargement réservations : " + (error.message || "");
          msgEl.classList.add("error");
          return;
        }

        if (!data || data.length === 0) {
          msgEl.textContent = "Aucune réservation trouvée.";
          msgEl.classList.add("error");
          return;
        }

        data.forEach((row) => {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = row.date || "-";
          tr.appendChild(tdDate);

          const tdTime = document.createElement("td");
          const dTime = row.start_time ? new Date(row.start_time) : null;
          tdTime.textContent = dTime
            ? dTime.toLocaleTimeString("fr-FR", { hour:"2-digit", minute:"2-digit" })
            : "-";
          tr.appendChild(tdTime);

          const tdClient = document.createElement("td");
          tdClient.textContent = row.name || "-";
          tr.appendChild(tdClient);

          const tdEmail = document.createElement("td");
          tdEmail.textContent = row.email || "-";
          tr.appendChild(tdEmail);

          const tdStatus = document.createElement("td");
          const badge = document.createElement("span");
          badge.classList.add("badge");
          if (row.status === "confirmed") { badge.classList.add("badge-active"); badge.textContent = "Confirmée"; }
          else if (row.status === "cancelled") { badge.classList.add("badge-inactive"); badge.textContent = "Annulée"; }
          else if (row.status === "pending") { badge.classList.add("badge-inactive"); badge.textContent = "En attente"; }
          else { badge.classList.add("badge-inactive"); badge.textContent = row.status || "Autre"; }
          tdStatus.appendChild(badge);
          tr.appendChild(tdStatus);

          tbody.appendChild(tr);
        });

        msgEl.textContent = "";
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Erreur réseau lors du chargement des réservations.";
        msgEl.classList.add("error");
      }
    }

    // -------------------------
    // CLIENTS (depuis reservations)
    // -------------------------
    async function loadClients() {
      const tbody = document.getElementById("clients-table-body");
      const msgEl = document.getElementById("clients-list-message");
      if (!tbody || !msgEl) return;

      tbody.innerHTML = "";
      msgEl.textContent = "Chargement des clients...";
      msgEl.className = "status-message";

      try {
        const { data, error } = await supabaseClient
          .from("reservations")
          .select("name, email, start_time")
          .order("start_time", { ascending: false });

        if (error) {
          console.error(error);
          msgEl.textContent = "Erreur chargement clients : " + (error.message || "");
          msgEl.classList.add("error");
          return;
        }

        if (!data || data.length === 0) {
          msgEl.textContent = "Aucun client trouvé (pas de réservations).";
          msgEl.classList.add("error");
          return;
        }

        const map = new Map();
        data.forEach((row) => {
          const email = row.email || "inconnu";
          if (!map.has(email)) {
            map.set(email, { name: row.name || "-", email, reservationsCount: 0, lastDate: null });
          }
          const entry = map.get(email);
          entry.reservationsCount += 1;
          const d = row.start_time ? new Date(row.start_time) : null;
          if (d && (!entry.lastDate || d > entry.lastDate)) entry.lastDate = d;
        });

        const clients = Array.from(map.values()).sort((a,b) => (b.lastDate||0) - (a.lastDate||0));

        clients.forEach((c) => {
          const tr = document.createElement("tr");
          const tdName = document.createElement("td"); tdName.textContent = c.name; tr.appendChild(tdName);
          const tdEmail = document.createElement("td"); tdEmail.textContent = c.email; tr.appendChild(tdEmail);
          const tdCount = document.createElement("td"); tdCount.textContent = c.reservationsCount; tr.appendChild(tdCount);
          const tdLast = document.createElement("td"); tdLast.textContent = c.lastDate ? formatDateTimeFr(c.lastDate) : "-"; tr.appendChild(tdLast);
          tbody.appendChild(tr);
        });

        msgEl.textContent = "";
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Erreur réseau lors du chargement des clients.";
        msgEl.classList.add("error");
      }
    }

    // -------------------------
    // ACTUALITES (CRUD)
    // -------------------------
    function resetArticleForm() {
      document.getElementById("a-id").value = "";
      document.getElementById("a-titre").value = "";
      document.getElementById("a-slug").value = "";
      document.getElementById("a-image").value = "";
      document.getElementById("a-chapeau").value = "";
      document.getElementById("a-contenu").value = "";
      document.getElementById("a-categorie").value = "coulisses-travaux";
      document.getElementById("a-publie").checked = false;
      document.getElementById("a-datepub").value = "";
      setMsg("article-form-message", "");
    }

    function normalizeSlug(s) {
      return (s || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^\w\-]/g, "")
        .replace(/\-+/g, "-")
        .replace(/^\-+|\-+$/g, "");
    }

    async function loadArticles() {
      const tbody = document.getElementById("articles-table-body");
      const msgEl = document.getElementById("articles-list-message");
      if (!tbody || !msgEl) return;

      tbody.innerHTML = "";
      msgEl.textContent = "Chargement des articles...";
      msgEl.className = "status-message";

      try {
        const { data, error } = await supabaseClient
          .from("actualites")
          .select("id, titre, slug, categorie, publie, date_publication, created_at")
          .order("created_at", { ascending: false });

        if (error) {
          console.error(error);
          msgEl.textContent = "Erreur chargement actualités : " + (error.message || "");
          msgEl.classList.add("error");
          return;
        }

        if (!data || data.length === 0) {
          msgEl.textContent = "Aucun article pour le moment.";
          msgEl.classList.add("error");
          return;
        }

        msgEl.textContent = "";

        data.forEach(row => {
          const tr = document.createElement("tr");

          const tdTitre = document.createElement("td"); tdTitre.textContent = row.titre || "-"; tr.appendChild(tdTitre);
          const tdSlug = document.createElement("td"); tdSlug.textContent = row.slug || "-"; tr.appendChild(tdSlug);

          const tdCat = document.createElement("td");
          tdCat.textContent = CATEGORY_LABELS[row.categorie] || row.categorie || "-";
          tr.appendChild(tdCat);

          const tdCreated = document.createElement("td");
          tdCreated.textContent = row.created_at ? formatDateFr(row.created_at) : "-";
          tr.appendChild(tdCreated);

          const tdPub = document.createElement("td");
          tdPub.textContent = row.date_publication ? formatDateFr(row.date_publication) : "-";
          tr.appendChild(tdPub);

          const tdStatus = document.createElement("td");
          const badge = document.createElement("span");
          badge.classList.add("badge");
          if (row.publie) { badge.classList.add("badge-active"); badge.textContent = "Publié"; }
          else { badge.classList.add("badge-inactive"); badge.textContent = "Brouillon"; }
          tdStatus.appendChild(badge);
          tr.appendChild(tdStatus);

          const tdActions = document.createElement("td");

          const editBtn = document.createElement("button");
          editBtn.className = "small-btn";
          editBtn.textContent = "Éditer";
          editBtn.addEventListener("click", async () => {
            await loadArticleIntoForm(row.id);
            // Switch sur l'onglet actualites si besoin
            document.querySelector('.tab-button[data-tab="tab-actualites"]').click();
            window.scrollTo({ top: 0, behavior: "smooth" });
          });
          tdActions.appendChild(editBtn);

          const delBtn = document.createElement("button");
          delBtn.className = "small-btn danger";
          delBtn.textContent = "Supprimer";
          delBtn.addEventListener("click", async () => {
            if (confirm("Supprimer l’article \"" + (row.titre || row.slug) + "\" ?")) {
              await deleteArticle(row.id);
            }
          });
          tdActions.appendChild(delBtn);

          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error(err);
        msgEl.textContent = "Erreur réseau chargement actualités.";
        msgEl.classList.add("error");
      }
    }

    async function loadArticleIntoForm(id) {
      setMsg("article-form-message", "Chargement de l’article...", true);
      const { data, error } = await supabaseClient
        .from("actualites")
        .select("*")
        .eq("id", id)
        .maybeSingle();

      if (error || !data) {
        console.error(error);
        setMsg("article-form-message", "Impossible de charger l’article.", false);
        return;
      }

      document.getElementById("a-id").value = data.id || "";
      document.getElementById("a-titre").value = data.titre || "";
      document.getElementById("a-slug").value = data.slug || "";
      document.getElementById("a-image").value = data.image_url || "";
      document.getElementById("a-chapeau").value = data.chapeau || "";
      document.getElementById("a-contenu").value = data.contenu || "";
      document.getElementById("a-categorie").value = data.categorie || "coulisses-travaux";
      document.getElementById("a-publie").checked = !!data.publie;

      // datetime-local attends "YYYY-MM-DDTHH:mm"
      if (data.date_publication) {
        const d = new Date(data.date_publication);
        if (!isNaN(d)) {
          const pad = (n) => String(n).padStart(2,"0");
          const v = d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+"T"+pad(d.getHours())+":"+pad(d.getMinutes());
          document.getElementById("a-datepub").value = v;
        }
      } else {
        document.getElementById("a-datepub").value = "";
      }

      setMsg("article-form-message", "Mode édition ✔", true);
    }

    async function upsertArticle(payload, id) {
      // si "publie" et pas de date_publication -> set now
      if (payload.publie && !payload.date_publication) {
        payload.date_publication = new Date().toISOString();
      }

      const msgId = "article-form-message";
      setMsg(msgId, "Enregistrement en cours...", true);

      try {
        let q = supabaseClient.from("actualites");
        const res = id
          ? await q.update(payload).eq("id", id)
          : await q.insert([payload]);

        if (res.error) {
          console.error(res.error);
          setMsg(msgId, "Erreur : " + (res.error.message || "impossible"), false);
          return;
        }

        setMsg(msgId, "Article enregistré ✅", true);
        resetArticleForm();
        await loadArticles();
      } catch (err) {
        console.error(err);
        setMsg(msgId, "Erreur réseau.", false);
      }
    }

    async function deleteArticle(id) {
      const msgEl = document.getElementById("articles-list-message");
      msgEl.textContent = "Suppression en cours...";
      msgEl.className = "status-message";

      const { error } = await supabaseClient.from("actualites").delete().eq("id", id);
      if (error) {
        console.error(error);
        msgEl.textContent = "Erreur suppression : " + (error.message || "");
        msgEl.classList.add("error");
        return;
      }
      msgEl.textContent = "Article supprimé.";
      msgEl.classList.add("ok");
      await loadArticles();
    }

    // -------------------------
    // PROMO CODES (CRUD)
    // -------------------------
    async function handlePromoFormSubmit() {
      const codeInput = document.getElementById("promo-code");
      const typeInput = document.getElementById("promo-type");
      const valueInput = document.getElementById("promo-value");
      const validFromInput = document.getElementById("promo-valid-from");
      const validToInput = document.getElementById("promo-valid-to");
      const maxUsesInput = document.getElementById("promo-max-uses");
      const maxPerEmailInput = document.getElementById("promo-max-per-email");
      const firstSessionInput = document.getElementById("promo-first-session");
      const emailDomainInput = document.getElementById("promo-email-domain");
      const noteInput = document.getElementById("promo-note");
      const msgEl = document.getElementById("promo-form-message");

      msgEl.textContent = "";
      msgEl.className = "status-message";

      const code = (codeInput.value || "").trim().toUpperCase();
      const type = typeInput.value;
      let numericValue = valueInput.value ? parseFloat(valueInput.value) : 0;

      if (!code) { msgEl.textContent = "Merci de saisir un code."; msgEl.classList.add("error"); return; }
      if (type !== "free" && (!numericValue || numericValue <= 0)) { msgEl.textContent = "Merci de mettre une valeur > 0."; msgEl.classList.add("error"); return; }
      if (type === "free") numericValue = 0;

      const payload = {
        code,
        type,
        value: numericValue,
        valid_from: validFromInput.value || null,
        valid_to: validToInput.value || null,
        max_uses: maxUsesInput.value ? parseInt(maxUsesInput.value, 10) : null,
        max_uses_per_user: maxPerEmailInput.value ? parseInt(maxPerEmailInput.value, 10) : null,
        first_session_only: !!(firstSessionInput && firstSessionInput.checked),
        email_domain: (emailDomainInput.value || "").trim() || null,
        note: (noteInput.value || "").trim() || null,
        is_active: true
      };

      msgEl.textContent = "Enregistrement en cours...";
      try {
        const { error } = await supabaseClient
          .from("promo_codes")
          .upsert(payload, { onConflict: "code" });

        if (error) {
          console.error(error);
          msgEl.textContent = "Erreur : " + (error.message || "enregistrement impossible.");
          msgEl.classList.add("error");
        } else {
          msgEl.textContent = "Code enregistré ✅";
          msgEl.classList.add("ok");
          await loadPromoCodes();
        }
      } catch (err) {
        console.error(err);
        msgEl.textContent = "Erreur réseau.";
        msgEl.classList.add("error");
      }
    }

    async function loadPromoCodes() {
      const tbody = document.getElementById("promo-table-body");
      const msgEl = document.getElementById("promo-list-message");
      if (!tbody || !msgEl) return;

      tbody.innerHTML = "";
      msgEl.textContent = "Chargement des codes promo...";
      msgEl.className = "status-message";

      try {
        const { data, error } = await supabaseClient
          .from("promo_codes")
          .select("*")
          .order("code", { ascending: true });

        if (error) {
          console.error(error);
          msgEl.textContent = "Erreur chargement : " + (error.message || "");
          msgEl.classList.add("error");
          return;
        }

        msgEl.textContent = "";
        if (!data || data.length === 0) {
          msgEl.textContent = "Aucun code promo.";
          msgEl.classList.add("error");
          return;
        }

        data.forEach((row) => {
          const tr = document.createElement("tr");

          const tdCode = document.createElement("td");
          tdCode.textContent = row.code;
          tr.appendChild(tdCode);

          const tdType = document.createElement("td");
          let typeLabel = row.type || "-";
          if (row.type === "free") typeLabel = 'Gratuit (free)';
          if (row.type === "percent") typeLabel = "Pourcentage";
          if (row.type === "fixed") typeLabel = "Montant fixe";

          const extras = [];
          if (row.note) extras.push(row.note);
          if (row.first_session_only) extras.push("1ère session");
          if (row.max_uses_per_user) extras.push(row.max_uses_per_user + "x / email");
          if (row.email_domain) extras.push("@" + row.email_domain);

          tdType.textContent = extras.length ? (typeLabel + " · " + extras.join(" · ")) : typeLabel;
          tr.appendChild(tdType);

          const tdValue = document.createElement("td");
          if (row.type === "percent") tdValue.textContent = (row.value || 0) + " %";
          else if (row.type === "fixed") tdValue.textContent = (row.value || 0) + " €";
          else tdValue.textContent = "-";
          tr.appendChild(tdValue);

          const tdFrom = document.createElement("td"); tdFrom.textContent = row.valid_from || "-"; tr.appendChild(tdFrom);
          const tdTo = document.createElement("td"); tdTo.textContent = row.valid_to || "-"; tr.appendChild(tdTo);

          const tdUses = document.createElement("td");
          tdUses.textContent = (row.used_count || 0) + " / " + (row.max_uses || "∞");
          tr.appendChild(tdUses);

          const tdStatus = document.createElement("td");
          const badge = document.createElement("span");
          badge.classList.add("badge");
          if (row.is_active) { badge.classList.add("badge-active"); badge.textContent = "Actif"; }
          else { badge.classList.add("badge-inactive"); badge.textContent = "Inactif"; }
          tdStatus.appendChild(badge);
          tr.appendChild(tdStatus);

          const tdActions = document.createElement("td");

          const toggleBtn = document.createElement("button");
          toggleBtn.className = "small-btn";
          toggleBtn.textContent = row.is_active ? "Désactiver" : "Activer";
          toggleBtn.addEventListener("click", async () => {
            await togglePromoActive(row.id, !row.is_active);
          });
          tdActions.appendChild(toggleBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "small-btn danger";
          deleteBtn.textContent = "Supprimer";
          deleteBtn.addEventListener("click", async () => {
            if (confirm(`Supprimer le code ${row.code} ?`)) {
              await deletePromo(row.id);
            }
          });
          tdActions.appendChild(deleteBtn);

          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error(err);
        msgEl.textContent = "Erreur réseau.";
        msgEl.classList.add("error");
      }
    }

    async function togglePromoActive(id, newStatus) {
      const msgEl = document.getElementById("promo-list-message");
      msgEl.textContent = "Mise à jour...";
      msgEl.className = "status-message";

      const { error } = await supabaseClient
        .from("promo_codes")
        .update({ is_active: newStatus })
        .eq("id", id);

      if (error) {
        console.error(error);
        msgEl.textContent = "Erreur : " + (error.message || "");
        msgEl.classList.add("error");
        return;
      }
      msgEl.textContent = "Statut mis à jour.";
      msgEl.classList.add("ok");
      await loadPromoCodes();
    }

    async function deletePromo(id) {
      const msgEl = document.getElementById("promo-list-message");
      msgEl.textContent = "Suppression...";
      msgEl.className = "status-message";

      const { error } = await supabaseClient.from("promo_codes").delete().eq("id", id);
      if (error) {
        console.error(error);
        msgEl.textContent = "Erreur : " + (error.message || "");
        msgEl.classList.add("error");
        return;
      }
      msgEl.textContent = "Code supprimé.";
      msgEl.classList.add("ok");
      await loadPromoCodes();
    }

    // -------------------------
    // INIT
    // -------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      initTabs();

      document.getElementById("login-button").addEventListener("click", handleLogin);
      document.getElementById("logout-button").addEventListener("click", handleLogout);

      document.getElementById("admin-password").addEventListener("keyup", (e) => {
        if (e.key === "Enter") handleLogin();
      });

      // Actualités
      document.getElementById("article-reset").addEventListener("click", resetArticleForm);
      document.getElementById("btn-refresh-articles").addEventListener("click", loadArticles);

      // auto slug depuis titre si slug vide
      document.getElementById("a-titre").addEventListener("input", () => {
        const slugEl = document.getElementById("a-slug");
        if (!slugEl.value.trim()) slugEl.value = normalizeSlug(document.getElementById("a-titre").value);
      });
      document.getElementById("a-slug").addEventListener("blur", () => {
        const slugEl = document.getElementById("a-slug");
        slugEl.value = normalizeSlug(slugEl.value);
      });

      document.getElementById("article-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const id = document.getElementById("a-id").value || null;
        const titre = document.getElementById("a-titre").value.trim();
        const slug = normalizeSlug(document.getElementById("a-slug").value);
        const image_url = document.getElementById("a-image").value.trim() || null;
        const chapeau = document.getElementById("a-chapeau").value.trim() || null;
        const contenu = document.getElementById("a-contenu").value || null;
        const categorie = document.getElementById("a-categorie").value || "coulisses-travaux";
        const publie = document.getElementById("a-publie").checked;
        const dateLocal = document.getElementById("a-datepub").value || null;

        if (!titre || !slug) {
          setMsg("article-form-message", "Titre + slug requis.", false);
          return;
        }

        const payload = {
          titre,
          slug,
          image_url,
          chapeau,
          contenu,
          categorie,
          publie,
          date_publication: dateLocal ? new Date(dateLocal).toISOString() : null
        };

        await upsertArticle(payload, id);
      });

      // Réservations / clients
      document.getElementById("btn-refresh-reservations").addEventListener("click", loadReservations);
      document.getElementById("btn-refresh-clients").addEventListener("click", loadClients);

      // Promo
      document.getElementById("promo-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        await handlePromoFormSubmit();
      });
      document.getElementById("btn-refresh-promo").addEventListener("click", loadPromoCodes);

      // Auto refresh quand session change
      supabaseClient.auth.onAuthStateChange(async (_event, _session) => {
        await refreshAuthUI();
      });

      await refreshAuthUI();
    });
  </script>
</body>
</html>
