<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Paiement karaok√© box Singbox | Panier & r√®glement s√©curis√© √† Toulouse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO -->
  <meta name="description" content="Finalisez le paiement s√©curis√© de votre karaok√© box Singbox √† Toulouse. V√©rifiez votre panier, appliquez votre code promo et r√©glez vos r√©servations en quelques clics." />
  <!-- Page de paiement : on √©vite l‚Äôindexation -->
  <meta name="robots" content="noindex,nofollow" />
  <meta name="author" content="Singbox" />
  <meta name="theme-color" content="#050814" />
  <meta name="keywords" content="paiement Singbox, paiement karaok√© Toulouse, panier Singbox, r√©servation karaok√© box, r√®glement s√©curis√©, karaok√© privatif Toulouse" />
  <link rel="canonical" href="https://www.singbox.fr/paiement" />

  <!-- Open Graph / Facebook -->
  <meta property="og:locale" content="fr_FR" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Paiement r√©servation karaok√© box - Singbox Toulouse" />
  <meta property="og:description" content="R√©glez en ligne votre s√©ance de karaok√© priv√© chez Singbox √† Toulouse : cr√©neaux flexibles, paiement s√©curis√© et codes promo disponibles." />
  <meta property="og:site_name" content="Singbox" />
  <meta property="og:url" content="https://www.singbox.fr/paiement" />
  <!-- √Ä adapter avec votre visuel de partage -->
  <meta property="og:image" content="https://www.singbox.fr/images/singbox-social.jpg" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Paiement r√©servation karaok√© box - Singbox Toulouse" />
  <meta name="twitter:description" content="Finalisez en ligne votre r√©servation de karaok√© box Singbox √† Toulouse avec un paiement 100 % s√©curis√©." />
  <meta name="twitter:image" content="https://www.singbox.fr/images/singbox-social.jpg" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

  <!-- Donn√©es structur√©es JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Paiement r√©servation karaok√© box - Singbox Toulouse",
    "url": "https://www.singbox.fr/paiement",
    "description": "Page de paiement s√©curis√© pour finaliser votre r√©servation de karaok√© box priv√©e chez Singbox √† Toulouse.",
    "inLanguage": "fr-FR",
    "isPartOf": {
      "@type": "WebSite",
      "name": "Singbox",
      "url": "https://www.singbox.fr"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Singbox",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.singbox.fr/logo.png"
      }
    }
  }
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@600;700;800&family=Montserrat:wght@300;400;500;600&display=swap"
    rel="stylesheet"
  >

  <style>
    :root {
      --sb-bg-main: #050814;
      --sb-bg-deep: #020617;
      --sb-bg-soft: #030712;
      --sb-card: #050b18;
      --sb-text-main: #F9FAFB;
      --sb-text-muted: #9CA3AF;
      --sb-red: #C94C35;
      --sb-orange: #F97316;
      --sb-border-soft: rgba(148, 163, 184, 0.35);
      --sb-container-width: 1180px;
    }
    
        /* ‚úÖ Masquage √©l√©gant du champ carte quand on paye avec carte enregistr√©e */
.card-element-wrapper.is-hidden {
  display: none;
}

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--sb-text-main);
      background:
        radial-gradient(circle at 10% 0%, rgba(107,18,32,0.65), transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(30,64,175,0.7), transparent 60%),
        linear-gradient(145deg, #020617 0, #020617 40%, var(--sb-bg-main) 100%);
      min-height: 100vh;
      overflow-x: hidden;
    }

    a { text-decoration: none; color: inherit; }

    h1, h2, h3, h4 {
      font-family: "League Spartan", system-ui, sans-serif;
      letter-spacing: 0.03em;
      margin: 0;
    }

    .container {
      max-width: var(--sb-container-width);
      margin: 0 auto;
      padding: 0 24px;
    }

    /* ======================= HEADER GLOBAL ======================= */

    .site-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
      background: #020617;
      color: #fff;
      box-shadow: 0 14px 30px rgba(0,0,0,0.75);
      height: auto;
    }

    .header-inner {
      max-width: var(--sb-container-width);
      margin: 0 auto;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      height: auto;
      flex-wrap: nowrap;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      flex-shrink: 0;
    }

    .brand-logo {
      width: 110px;
      height: auto;
      border-radius: 999px;
      display: block;
      object-fit: contain;
      filter:
        drop-shadow(0 0 12px rgba(255,255,255,0.16))
        drop-shadow(0 0 20px rgba(201,76,53,0.6));
    }

    .brand-text {
      font-family: "League Spartan", system-ui, sans-serif;
      font-weight: 600;
      letter-spacing: 0.15em;
      font-size: 26px;
      color: #F9FAFB;
      text-transform: uppercase;
      white-space: nowrap;
      display: flex;
      align-items: center;
    }

    nav.main-nav {
      flex: 1;
      display: flex;
      justify-content: center;
      min-width: 0;
    }

    .main-nav ul {
      list-style: none;
      display: flex;
      gap: 32px;
      margin: 0;
      padding: 0;
      font-size: 14px;
    }

    .main-nav a {
      font-weight: 600;
      letter-spacing: 0.3px;
      color: #ffffff;
      text-decoration: none;
      position: relative;
      padding-bottom: 4px;
      white-space: nowrap;
    }

    .main-nav a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: 0;
      width: 0%;
      height: 2px;
      background: linear-gradient(90deg, #ff6930, #ffb96f);
      transition: width 0.3s ease;
      border-radius: 6px;
    }

    .main-nav a:hover::after {
      width: 100%;
    }

    .main-nav a:hover {
      color: #ffb96f;
      transition: 0.25s ease;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .nav-cta {
      background: var(--sb-red);
      padding: 8px 22px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 14px;
      color: #F9FAFB;
      white-space: nowrap;
      box-shadow:
        0 0 0 1px rgba(249,250,251,0.08),
        0 10px 28px rgba(0,0,0,0.7);
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
    }

    .nav-cta:hover {
      background: #d55a40;
      transform: translateY(-1px);
      box-shadow:
        0 0 0 1px rgba(249,250,251,0.18),
        0 16px 38px rgba(0,0,0,0.9);
    }

    .cart-icon {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      position: relative;
      background: radial-gradient(circle at 30% 0%, rgba(248,250,252,0.16), rgba(15,23,42,0.85));
      backdrop-filter: blur(6px);
    }

    #cart-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background: var(--sb-red);
      color:#fff;
      border-radius:999px;
      font-size:10px;
      padding: 2px 5px;
      min-width: 18px;
      text-align:center;
    }
    #cart-count:empty { display:none; }

    .burger-button {
      display: none;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      background: transparent;
      color:#fff;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
    }

    .mobile-nav {
      display: none;
      position: fixed;
      top: 70px;
      left: 0;
      right: 0;
      background: #020617;
      padding: 12px 24px 16px;
      z-index: 40;
      border-bottom: 1px solid #111827;
    }

    .mobile-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
      font-size: 15px;
    }

    .mobile-nav a { color:#fff; }
    .mobile-nav.open { display:block; }

    /* --------- HEADER RESPONSIVE --------- */
    @media (max-width: 900px) {
      .header-inner {
        padding: 8px 10px;
        gap: 8px;
      }

      nav.main-nav {
        display: none;
      }

      .brand-logo {
        width: 58px;
      }

      .brand-text {
        font-size: 15px;
        letter-spacing: 0.11em;
      }

      .nav-cta {
        padding: 6px 12px;
        font-size: 11px;
      }

      .cart-icon,
      .burger-button {
        width: 32px;
        height: 32px;
        font-size: 18px;
      }

      .burger-button {
        display: flex;
      }
    }

    @media (max-width: 480px) {
      .header-inner {
        padding: 8px 8px;
        gap: 6px;
      }

      .brand-logo {
        width: 50px;
      }

      .brand-text {
        font-size: 13px;
        letter-spacing: 0.09em;
      }

      .nav-cta {
        padding: 5px 10px;
        font-size: 10px;
      }

      .cart-icon,
      .burger-button {
        width: 30px;
        height: 30px;
        font-size: 16px;
      }
    }

    /* ======================= SECTION PANIER / PAIEMENT ======================= */

    #checkout {
      position: relative;
      padding: 12rem 0 64px;
      background:
        radial-gradient(circle at 25% 0%, rgba(201,76,53,0.35), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(37,99,235,0.45), transparent 60%),
        #050814;
      color: var(--sb-text-main);
      overflow: hidden;
    }

    #checkout::before {
      content: "‚ô™";
      position: absolute;
      top: 16%;
      left: 8%;
      font-size: 32px;
      color: rgba(148,163,184,0.08);
      pointer-events: none;
    }

    #checkout::after {
      content: "‚ú¶";
      position: absolute;
      bottom: 14%;
      right: 10%;
      font-size: 30px;
      color: rgba(148,163,184,0.08);
      pointer-events: none;
    }

    .checkout-header {
      max-width: 640px;
      margin: 0 auto 32px;
      text-align: center;
    }

    .checkout-header-eyebrow {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #9CA3AF;
      margin-bottom: 8px;
    }

    .checkout-header h1 {
      font-size: 30px;
      margin-bottom: 8px;
    }

    .checkout-header p {
      margin: 0;
      font-size: 14px;
      color: rgba(249,250,251,0.85);
    }

    .checkout-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
      gap: 1.75rem;
      align-items: flex-start;
    }

    .card {
      background: var(--sb-card);
      border-radius: 24px;
      padding: 1.75rem 1.9rem;
      box-shadow:
        0 24px 60px rgba(0,0,0,0.9),
        0 0 0 1px rgba(148,163,184,0.3);
      border: 1px solid rgba(255,255,255,0.04);
      position: relative;
      overflow: hidden;
    }

    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 0 0, rgba(148,163,184,0.1), transparent 60%);
      opacity: 0.6;
      mix-blend-mode: soft-light;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .billing-card h2 {
      font-size: 22px;
      margin-bottom: 14px;
    }

    .billing-form-grid-2 {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 0.9rem;
      margin-bottom: 0.9rem;
    }

    .billing-field {
      margin-bottom: 0.9rem;
      font-size: 13px;
    }

    .billing-field label {
      display: block;
      margin-bottom: 4px;
      color: #E5E7EB;
    }

    .billing-field .field-help {
      margin: 4px 0 0;
      font-size: 11px;
      color: var(--sb-text-muted);
    }

    .billing-field input,
    .billing-field select {
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      color: #F9FAFB;
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--sb-border-soft);
      padding: 0.65rem 0.9rem;
      outline: none;
      transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease;
    }

    .billing-field select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #9CA3AF 50%),
        linear-gradient(135deg, #9CA3AF 50%, transparent 50%);
      background-position:
        calc(100% - 14px) calc(50% - 3px),
        calc(100% - 8px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    .billing-field input::placeholder {
      color: rgba(156,163,175,0.9);
    }

    .billing-field input:focus,
    .billing-field select:focus {
      border-color: var(--sb-orange);
      box-shadow:
        0 0 0 1px rgba(249,115,22,0.9),
        0 0 28px rgba(249,115,22,0.35);
    }

    .billing-type-toggle {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(148,163,184,0.35);
      margin-bottom: 14px;
      font-size: 12px;
      gap: 4px;
    }

    .billing-type-option {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      color: #E5E7EB;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .billing-type-option input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .billing-type-option span {
      position: relative;
    }

    .billing-type-option input:checked + span {
      background: linear-gradient(90deg, var(--sb-red), var(--sb-orange));
      border-radius: 999px;
      padding: 6px 14px;
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.18),
        0 12px 30px rgba(0,0,0,0.9);
    }

    /* ======================= COLONNE DROITE ======================= */

    .summary-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .order-card h2 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .order-lines {
      font-size: 13px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      padding-bottom: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .order-product-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .order-meta {
      margin: 0;
      color: var(--sb-text-muted);
      line-height: 1.5;
    }

    .order-totals {
      font-size: 13px;
      margin-top: 0.5rem;
    }

    .order-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .order-row.total {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(31,41,55,0.9);
      font-size: 15px;
      font-weight: 700;
    }

    .order-note {
      font-size: 11px;
      color: var(--sb-text-muted);
      margin-top: 2px;
    }

    /* Code promo bloc */

    .promo-card {
      font-size: 12px;
    }

    .promo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .promo-header span {
      font-weight: 600;
      font-size: 13px;
    }

    .promo-toggle {
      font-size: 12px;
      color: #F97316;
      text-decoration: underline;
      cursor: pointer;
      white-space: nowrap;
      background: transparent;
      border: none;
      padding: 0;
    }

    .promo-toggle:hover {
      text-decoration: none;
    }

    .promo-body {
      margin-top: 6px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.25s ease;
    }

    .promo-body.open {
      max-height: 200px;
    }

    .promo-input-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .promo-input-group input[type="text"] {
      flex: 1 1 130px;
      min-width: 0;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--sb-border-soft);
      background:#020617;
      color:#F9FAFB;
      font-size: 13px;
      outline:none;
    }

    .promo-input-group input::placeholder {
      color: rgba(156,163,175,0.9);
    }

    .promo-input-group button {
      border-radius: 999px;
      border: none;
      padding: 0.5rem 1.1rem;
      font-size: 12px;
      cursor: pointer;
      background: linear-gradient(90deg, var(--sb-red), var(--sb-orange));
      color: #F9FAFB;
      font-weight: 600;
      white-space: nowrap;
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.08),
        0 12px 30px rgba(0,0,0,0.8);
    }

    .promo-message {
      margin-top: 4px;
      font-size: 11px;
      color: var(--sb-text-muted);
    }

    .promo-message.ok { color:#BBF7D0; }
    .promo-message.error { color:#FCA5A5; }

    /* Paiement */

    .payment-card h3 {
      font-size: 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .payment-logos {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      font-size: 11px;
      margin-bottom: 8px;
    }

    .payment-logo {
      width: 30px;
      height: 20px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #020617;
      background: #FACC15;
    }

    .payment-logo.visa {
      background: #1D4ED8;
      color: #F9FAFB;
    }

    .payment-logo.mc {
      background: linear-gradient(90deg,#F97316,#EF4444);
      color:#F9FAFB;
    }

    .payment-info {
      font-size: 11px;
      color: var(--sb-text-muted);
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .payment-info a {
      color: #F97316;
      text-decoration: underline;
    }
    .payment-info a:hover {
      text-decoration: none;
    }

    .card-element-wrapper {
      margin-bottom: 10px;
    }

    #card-element {
      padding: 0.65rem 0.8rem;
      border-radius: 14px;
      border: 1px solid var(--sb-border-soft);
      background:#020617;
    }

    #card-errors {
      font-size: 11px;
      color:#FCA5A5;
      margin-top:4px;
      min-height:1em;
    }

    .payment-consents {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      margin-top: 8px;
      margin-bottom: 10px;
    }

    .payment-consents label {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      cursor: pointer;
    }

    .payment-consents input[type="checkbox"] {
      margin-top: 2px;
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid var(--sb-border-soft);
      background: #020617;
      accent-color: var(--sb-red);
      flex-shrink: 0;
    }

    .payment-consents a {
      color: #F97316;
      text-decoration: underline;
    }

    .payment-consents a:hover {
      text-decoration: none;
    }

    .payment-warning {
      font-size: 12px;
      border-radius: 14px;
      border: 1px solid rgba(248,113,113,0.8);
      background: rgba(127,29,29,0.65);
      padding: 6px 10px;
      color: #FEE2E2;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .payment-warning span:first-child {
      font-size: 16px;
    }

    .checkout-error {
      font-size: 13px;
      color: #FCA5A5;
      margin-top: 8px;
      min-height: 1.2em;
      font-weight: 500;
    }

    .checkout-success {
      font-size: 11px;
      color: #BBF7D0;
      margin-top: 4px;
      min-height: 1em;
    }

    .checkout-submit {
      display: flex;
      justify-content: stretch;
      margin-top: 8px;
    }

    .checkout-submit button {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 0.85rem 1.4rem;
      background: linear-gradient(90deg, var(--sb-red), var(--sb-orange));
      color: #F9FAFB;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.14),
        0 20px 50px rgba(0,0,0,0.95);
      transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
    }

    .checkout-submit button:hover:not([disabled]) {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.18),
        0 26px 65px rgba(0,0,0,1);
    }

    .checkout-submit button[disabled] {
      opacity: 0.6;
      cursor: progress;
    }

    /* ======================= EMPTY CART STATE ======================= */

    .empty-cart {
      max-width: 640px;
      margin: 0 auto 32px;
      text-align: center;
    }
    .empty-cart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .empty-cart-text {
      font-size: 13px;
      color: var(--sb-text-muted);
      margin-bottom: 14px;
    }
    .empty-cart-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .empty-cart-btn-primary,
    .empty-cart-btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.6rem 1.4rem;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .empty-cart-btn-primary {
      background: linear-gradient(90deg, var(--sb-red), var(--sb-orange));
      color: #F9FAFB;
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.14),
        0 18px 45px rgba(0,0,0,0.95);
    }
    .empty-cart-btn-primary:hover {
      filter: brightness(1.04);
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.18),
        0 24px 65px rgba(0,0,0,1);
    }
    .empty-cart-btn-secondary {
      background: transparent;
      color: #E5E7EB;
      border-color: rgba(148,163,184,0.6);
    }
    .empty-cart-btn-secondary:hover {
      border-color: rgba(248,250,251,0.9);
    }

    /* ======================= PAGE MERCI (POST-PAIEMENT) ======================= */

    #thankyou-section {
      margin-top: 2.5rem;
      max-width: 760px;
      margin-left: auto;
      margin-right: auto;
      display: none;
    }

    .thankyou-card {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .thankyou-title {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .thankyou-subtitle {
      font-size: 13px;
      color: var(--sb-text-muted);
    }

    .thankyou-highlight-name {
      background: radial-gradient(circle at 0 0, rgba(249,115,22,0.25), transparent 55%);
      padding: 2px 8px;
      border-radius: 999px;
    }

    .thankyou-summary {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 1.25rem;
      font-size: 13px;
      align-items: stretch;
    }

    .thankyou-summary ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .thankyou-summary li strong {
      font-weight: 600;
    }

    .thankyou-qr {
      display: flex;
      align-items: stretch;
    }

    .thankyou-qr-inner {
      border-radius: 18px;
      border: 1px dashed rgba(148,163,184,0.5);
      background: radial-gradient(circle at 10% 0%, rgba(15,23,42,0.9), rgba(2,6,23,0.98));
      padding: 10px 12px;
      width: 100%;
      text-align: center;
    }

    .thankyou-qr-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--sb-text-muted);
      margin-bottom: 6px;
    }
    
.thankyou-qr-frame{
  width: 260px;                 /* cadre total */
  aspect-ratio: 1/1;
  background:#fff;
  padding:16px;                  /* quiet zone */
  border-radius:0;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto;
  box-sizing:border-box;
  position:relative;             /* utile pour fallback */
}

/* Le QR doit prendre 100% de la zone int√©rieure (= 228px) */
#thankyou-qr canvas {
  display: block;
}
#thankyou-qr-fallback{
  position:absolute;
  bottom:10px;
  left:0;
  right:0;
  text-align:center;
  font-size:11px;
  color:rgba(156,163,175,0.9);
}
    .thankyou-qr-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--sb-text-muted);
    }

    .thankyou-deposit {
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(248,250,251,0.08);
      background: rgba(15,23,42,0.9);
      line-height: 1.5;
    }

    .thankyou-deposit strong {
      display: block;
      margin-bottom: 4px;
    }

    .thankyou-practical {
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.8);
      line-height: 1.5;
    }

    .thankyou-practical strong {
      display: block;
      margin-bottom: 4px;
    }

    .thankyou-practical ul {
      margin: 4px 0 0 1.1rem;
      padding: 0;
      font-size: 12px;
    }

    .thankyou-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }

    .thankyou-btn-primary,
    .thankyou-btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.55rem 1.3rem;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid transparent;
      cursor: pointer;
      text-decoration: none;
      white-space: nowrap;
    }

    .thankyou-btn-primary {
      background: linear-gradient(90deg,var(--sb-red),var(--sb-orange));
      color: #F9FAFB;
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.14),
        0 18px 45px rgba(0,0,0,0.95);
    }

    .thankyou-btn-secondary {
      background: transparent;
      color: #E5E7EB;
      border-color: rgba(148,163,184,0.6);
    }

    .thankyou-btn-primary:hover {
      filter: brightness(1.04);
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.18),
        0 24px 65px rgba(0,0,0,1);
    }

    .thankyou-btn-secondary:hover {
      border-color: rgba(248,250,251,0.9);
    }

    @media (max-width: 900px) {
      .thankyou-summary {
        grid-template-columns: minmax(0,1fr);
      }
    }

    @media (max-width: 640px) {
      #thankyou-section {
        margin-top: 2rem;
      }

      .thankyou-card {
        padding: 1.55rem 1.45rem;
      }
    }

    /* ======================= FOOTER ======================= */
    footer {
      background:#020617;
      color:#e5e7eb;
      padding:32px 24px 18px;
      border-top: 1px solid #111827;
    }

    .newsletter-container {
      max-width:var(--sb-container-width);
      margin:0 auto 24px;
      text-align:center;
    }

    .newsletter-container h3 {
      margin-bottom: 6px;
    }

    .newsletter-container p {
      margin-top: 0;
      font-size: 13px;
      color: var(--sb-text-muted);
    }

    .newsletter-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      margin-top: 8px;
    }

    footer input[type=email] {
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.4);
      min-width:240px;
      max-width:360px;
      font-size:14px;
      background:#020617;
      color:#F9FAFB;
      outline: none;
    }

    footer input[type=email]::placeholder {
      color: rgba(156,163,175,0.9);
    }

    footer button {
      padding:10px 18px;
      border:none;
      border-radius:999px;
      background:linear-gradient(90deg,var(--sb-red),var(--sb-orange));
      color:#F9FAFB;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.12),
        0 16px 40px rgba(0,0,0,0.9);
    }

    .footer-columns {
      max-width:var(--sb-container-width);
      margin:0 auto;
      display:flex;
      flex-wrap:wrap;
      gap:24px;
      justify-content:space-between;
      font-size:13px;
    }

    .footer-brand {
      display:flex;
      align-items:center;
      gap:10px;
    }

    .footer-brand img {
      height:80px;
      width:auto;
      display:block;
    }

    .footer-columns p { margin:4px 0; }

    .footer-bottom {
      max-width:var(--sb-container-width);
      margin:20px auto 0;
      padding-top:8px;
      font-size:11px;
      text-align:center;
      color:#9CA3AF;
      border-top:1px solid #111827;
    }

    /* ======================= RESPONSIVE ======================= */

    @media (max-width: 900px) {
      #checkout {
        padding-top: 10rem;
      }

      .checkout-layout {
        grid-template-columns: minmax(0,1fr);
      }
    }

    @media (max-width: 640px) {
      .billing-form-grid-2 {
        grid-template-columns: minmax(0,1fr);
      }

      .card {
        padding: 1.55rem 1.45rem;
      }
    }

    /* ======================= MODAL AUTH FID√âLIT√â ======================= */

    .auth-modal-backdrop {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 10% 0%, rgba(15,23,42,0.9), rgba(2,6,23,0.96));
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
      padding: 16px;
    }

    .auth-modal-backdrop.open {
      display: flex;
    }

    .auth-modal {
      width: 100%;
      max-width: 440px;
      background: radial-gradient(circle at 10% 0%, rgba(249,115,22,0.18), transparent 55%),
                  radial-gradient(circle at 90% 0%, rgba(37,99,235,0.22), transparent 60%),
                  #020617;
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow:
        0 24px 70px rgba(0,0,0,0.95),
        0 0 0 1px rgba(15,23,42,0.9);
      padding: 20px 22px 18px;
      position: relative;
      overflow: hidden;
    }

    .auth-modal::after {
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 0 0, rgba(248,250,252,0.05), transparent 55%);
      mix-blend-mode: soft-light;
    }

    .auth-modal > * {
      position: relative;
      z-index: 1;
    }

    .auth-modal-eyebrow {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--sb-text-muted);
      margin-bottom: 4px;
    }

    .auth-modal h2 {
      font-size: 20px;
      margin-bottom: 6px;
    }

    .auth-modal-subtext {
      font-size: 12px;
      color: var(--sb-text-muted);
      margin-bottom: 10px;
    }

    .auth-loyalty-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(248,250,251,0.12);
      margin-bottom: 12px;
    }

    .auth-loyalty-pill span:first-child {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--sb-red),var(--sb-orange));
      font-size:11px;
    }

    .auth-tabs {
      display:flex;
      gap:6px;
      margin-bottom:10px;
      font-size:12px;
      background:#020617;
      border-radius:999px;
      padding:3px;
      border:1px solid rgba(148,163,184,0.35);
    }

    .auth-tab-btn {
      flex:1;
      border:none;
      border-radius:999px;
      padding:6px 10px;
      background:transparent;
      color:#E5E7EB;
      font-size:12px;
      font-weight:500;
      cursor:pointer;
      transition:background 0.15s ease,color 0.15s ease, box-shadow 0.15s ease;
    }

    .auth-tab-btn.active {
      background: linear-gradient(90deg,var(--sb-red),var(--sb-orange));
      color:#F9FAFB;
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.16),
        0 14px 34px rgba(0,0,0,0.9);
    }

    .auth-form {
      font-size:12px;
      margin-bottom:10px;
    }

    .auth-form.hidden {
      display:none;
    }

    .auth-field {
      margin-bottom:8px;
    }

    .auth-field label {
      display:block;
      margin-bottom:3px;
      color:#E5E7EB;
      font-size:12px;
    }

    .auth-field input {
      width:100%;
      font-family:inherit;
      font-size:12px;
      color:#F9FAFB;
      background:#020617;
      border-radius:999px;
      border:1px solid var(--sb-border-soft);
      padding:0.5rem 0.8rem;
      outline:none;
      transition:border-color 0.16s ease, box-shadow 0.16s ease;
    }

    .auth-field input::placeholder {
      color:rgba(156,163,175,0.9);
    }

    .auth-field input:focus {
      border-color:var(--sb-orange);
      box-shadow:
        0 0 0 1px rgba(249,115,22,0.8),
        0 0 22px rgba(249,115,22,0.25);
    }

    .auth-submit-btn {
      width:100%;
      border:none;
      border-radius:999px;
      padding:0.55rem 1rem;
      background:linear-gradient(90deg,var(--sb-red),var(--sb-orange));
      color:#F9FAFB;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      letter-spacing:0.06em;
      text-transform:uppercase;
      margin-top:4px;
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.12),
        0 16px 40px rgba(0,0,0,0.9);
      transition:transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
    }

    .auth-submit-btn:hover {
      transform:translateY(-1px);
      filter:brightness(1.03);
      box-shadow:
        0 0 0 1px rgba(248,250,251,0.18),
        0 22px 52px rgba(0,0,0,1);
    }

    .auth-modal-message {
      min-height:14px;
      font-size:11px;
      margin-bottom:6px;
      color:#FCA5A5;
    }

    .auth-modal-footer {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-top:6px;
      font-size:11px;
      color:var(--sb-text-muted);
    }

    .auth-modal-skip {
      border:none;
      background:transparent;
      color:#9CA3AF;
      font-size:11px;
      cursor:pointer;
      text-decoration:underline;
    }

    .auth-modal-skip:hover {
      color:#E5E7EB;
      text-decoration:none;
    }

    .auth-modal-small {
      font-size:10px;
      color:var(--sb-text-muted);
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="header-inner">
      <a href="index.html" class="brand">
        <img src="logo.png" alt="Logo Singbox, karaok√© box privatif √† Toulouse" class="brand-logo">
        <span class="brand-text">Singbox</span>
      </a>

      <nav class="main-nav" aria-label="Navigation principale">
        <ul>
          <li><a href="index.html">Accueil</a></li>
          <li><a href="concept.html">Le concept</a></li>
          <li><a href="box.html">Les box</a></li>
          <li><a href="actualites.html">Actualit√©s</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="mon-compte.html">Mon compte</a></li>
        </ul>
      </nav>

      <div class="header-actions">
        <a href="reservation.html" class="nav-cta">R√©server</a>
        <a href="panier.html" class="cart-icon" aria-label="Voir mon panier">
          üõí<span id="cart-count"></span>
        </a>
        <button class="burger-button" id="burger-button" aria-label="Ouvrir le menu">
          ‚ò∞
        </button>
      </div>
    </div>
  </header>

  <!-- MENU MOBILE -->
  <nav class="mobile-nav" id="mobile-nav" aria-label="Menu mobile">
    <ul>
      <li><a href="index.html">Accueil</a></li>
      <li><a href="concept.html">Le concept</a></li>
      <li><a href="box.html">Les box</a></li>
      <li><a href="actualites.html">Actualit√©s</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="mon-compte.html">Mon compte</a></li>
    </ul>
  </nav>

  <!-- MODAL CONNEXION / FID√âLIT√â -->
  <div id="auth-modal-backdrop" class="auth-modal-backdrop">
    <div class="auth-modal">
      <div class="auth-modal-eyebrow">Programme fid√©lit√©</div>
      <h2>Connectez-vous avant de payer</h2>
      <p class="auth-modal-subtext">
        Cr√©ez votre compte ou connectez-vous pour cumuler des points √† chaque session.
      </p>
      <div class="auth-loyalty-pill">
        <span>‚òÖ</span>
        <span>10 points par r√©servation payante. √Ä 100 points, votre prochaine s√©ance est offerte.</span>
      </div>

      <div class="auth-tabs">
        <button type="button" id="auth-btn-login" class="auth-tab-btn active">Se connecter</button>
        <button type="button" id="auth-btn-register" class="auth-tab-btn">Cr√©er un compte</button>
      </div>

      <div id="auth-modal-message" class="auth-modal-message"></div>

      <!-- Formulaire LOGIN -->
      <form id="auth-login-form" class="auth-form">
        <div class="auth-field">
          <label for="auth-login-email">Email</label>
          <input type="email" id="auth-login-email" placeholder="vous@email.fr" required>
        </div>
        <div class="auth-field">
          <label for="auth-login-password">Mot de passe</label>
          <input type="password" id="auth-login-password" placeholder="Mot de passe" required>
        </div>
        <button type="submit" class="auth-submit-btn">Connexion</button>
      </form>

      <!-- Formulaire REGISTER -->
      <form id="auth-register-form" class="auth-form hidden">
        <div class="auth-field">
          <label for="auth-register-email">Email</label>
          <input type="email" id="auth-register-email" placeholder="vous@email.fr" required>
        </div>
        <div class="auth-field">
          <label for="auth-register-password">Mot de passe</label>
          <input type="password" id="auth-register-password" placeholder="Mot de passe" required>
        </div>
        <button type="submit" class="auth-submit-btn">Cr√©er mon compte</button>
      </form>

      <div class="auth-modal-footer">
        <button type="button" id="auth-modal-continue" class="auth-modal-skip">
          Continuer sans compte (pas de points)
        </button>
        <span class="auth-modal-small">
          Vous pourrez retrouver vos points et vos r√©servations dans l‚Äôespace ‚ÄúMon compte‚Äù.
        </span>
      </div>
    </div>
  </div>

  <!-- MAIN CHECKOUT -->
  <section id="checkout">
    <div class="container">
      <div class="checkout-header">
        <p class="checkout-header-eyebrow">Panier & paiement</p>
        <h1>Finalisez votre r√©servation</h1>
        <p>V√©rifiez vos informations et votre commande avant de chanter chez Singbox.</p>
      </div>

      <!-- EMPTY CART STATE -->
      <div id="empty-cart-state" class="empty-cart" style="display:none;">
        <p class="empty-cart-title">Votre panier est vide üòÖ</p>
        <p class="empty-cart-text">
          Ajoutez au moins un cr√©neau de karaok√© pour pouvoir passer au paiement.
        </p>
        <div class="empty-cart-actions">
          <a href="panier.html" class="empty-cart-btn-secondary">Retour au panier</a>
          <a href="reservation.html" class="empty-cart-btn-primary">Voir les cr√©neaux disponibles</a>
        </div>
      </div>

      <div class="checkout-layout">
        <!-- COLONNE GAUCHE : FACTURATION -->
        <div class="billing-card card">
          <h2>D√©tails de facturation</h2>

          <div class="billing-type-toggle" role="radiogroup" aria-label="Type de client">
            <label class="billing-type-option">
              <input type="radio" name="client_type" value="particulier" checked />
              <span>Un particulier</span>
            </label>
            <label class="billing-type-option">
              <input type="radio" name="client_type" value="entreprise" />
              <span>Une entreprise</span>
            </label>
          </div>

          <form id="billing-form" novalidate>
            <div class="billing-form-grid-2">
              <div class="billing-field">
                <label for="prenom">Pr√©nom *</label>
                <input type="text" id="prenom" name="prenom" placeholder="Pr√©nom" required />
              </div>
              <div class="billing-field">
                <label for="nom">Nom *</label>
                <input type="text" id="nom" name="nom" placeholder="Nom" required />
              </div>
            </div>

            <div class="billing-field">
              <label for="pays">Pays / r√©gion *</label>
              <select id="pays" name="pays" required>
                <option value="FR" selected>France</option>
                <option value="BE">Belgique</option>
                <option value="CH">Suisse</option>
                <option value="other">Autre pays</option>
              </select>
            </div>

            <div class="billing-field">
              <label for="adresse">Num√©ro et nom de rue *</label>
              <input type="text" id="adresse" name="adresse" placeholder="Num√©ro de voie et nom de la rue" required />
            </div>

            <div class="billing-field">
              <label for="complement">B√¢timent, appartement, etc. (facultatif)</label>
              <input type="text" id="complement" name="complement" placeholder="B√¢timent, appartement, lot, etc." />
            </div>

            <div class="billing-form-grid-2">
              <div class="billing-field">
                <label for="cp">Code postal *</label>
                <input type="text" id="cp" name="cp" placeholder="Code postal" required />
              </div>
              <div class="billing-field">
                <label for="ville">Ville *</label>
                <input type="text" id="ville" name="ville" placeholder="Ville" required />
              </div>
            </div>

            <div class="billing-field">
              <label for="telephone">T√©l√©phone *</label>
              <input type="tel" id="telephone" name="telephone" placeholder="T√©l√©phone" required />
            </div>

            <div class="billing-field">
              <label for="email">Adresse e-mail *</label>
              <input type="email" id="email" name="email" placeholder="votre@email.fr" required />
            </div>

            <div class="billing-field">
              <label for="naissance">Date de naissance *</label>
              <input type="date" id="naissance" name="naissance" required />
              <p class="field-help">
                Utilis√©e uniquement pour v√©rifier la majorit√© (soir√©es alcoolis√©es, cr√©neaux tardifs, etc.).
              </p>
            </div>

            <!-- ‚≠ê‚≠ê BLOC FID√âLIT√â ‚≠ê‚≠ê -->
            <div id="loyalty-block" class="billing-field" style="margin-top:18px; display:none;">
              <label style="color:#F9FAFB; font-weight:600;">Programme Fid√©lit√© ‚≠ê</label>

              <div style="
                padding:12px 14px;
                background:#020617;
                border:1px solid rgba(255,255,255,0.15);
                border-radius:14px;
                line-height:1.45;
              ">
                <p style="margin:0; font-size:13px;">
                  Points disponibles : <b id="loyalty-points">0</b> ‚≠ê
                </p>
                <p style="margin:4px 0 10px; font-size:12px; color:#9CA3AF;">
                  100 points = 1 r√©servation gratuite
                </p>

                <button id="use-loyalty-btn" type="button"
                  style="
                    display:none;
                    width:100%;
                    padding:8px 14px;
                    border-radius:999px;
                    background:linear-gradient(90deg, var(--sb-red), var(--sb-orange));
                    color:white;
                    font-weight:600;
                    border:none;
                    cursor:pointer;
                    font-size:13px;
                  ">
                  Utiliser 100 points pour une r√©servation gratuite
                </button>

                <p id="loyalty-msg" style="font-size:12px; margin-top:6px; color:#BBF7D0;"></p>
              </div>
            </div>
            <!-- ‚≠ê‚≠ê FIN BLOC FID√âLIT√â ‚≠ê‚≠ê -->
          </form>
        </div>

        <!-- COLONNE DROITE : R√âCAP + PAIEMENT -->
        <div class="summary-column">
          <div class="order-card card">
            <h2>Votre commande</h2>

            <div class="order-lines">
              <div class="order-product-name" id="order-product-name">
                Votre s√©lection Singbox
              </div>
              <p class="order-meta" id="order-meta">
                Les d√©tails de vos cr√©neaux appara√Ætront ici.
              </p>
            </div>

            <div class="order-totals">
              <div class="order-row">
                <span>Sous-total (HT)</span>
                <span id="order-subtotal">0‚Ç¨</span>
              </div>
              <div class="order-row" id="order-discount-row" style="display:none;">
                <span>Remise</span>
                <span id="order-discount">-0‚Ç¨</span>
              </div>
              <div class="order-row">
                <span>TVA (20&nbsp;%)</span>
                <span id="order-tva">0‚Ç¨</span>
              </div>
              <div class="order-row total">
                <span>Total √† payer (TTC)</span>
                <span id="order-total">0‚Ç¨</span>
              </div>
              <p class="order-note">Paiement en une fois, toutes taxes comprises.</p>
            </div>
          </div>

          <!-- Code promo -->
          <div class="promo-card card">
            <div class="promo-header">
              <span>Code promo</span>
              <button type="button" class="promo-toggle" id="promo-toggle">
                Vous avez un code promo ?
              </button>
            </div>

            <div class="promo-body" id="promo-body">
              <div class="promo-input-group">
                <input type="text" id="promo-code" placeholder="SINGBOX10, NOEL..." autocomplete="off" />
                <button type="button" id="apply-promo">Appliquer</button>
              </div>
              <p id="promo-message" class="promo-message"></p>
            </div>
          </div>

          <!-- Paiement -->
          <div class="payment-card card">
            <h3>üí≥ Paiement s√©curis√©</h3>

            <div class="payment-logos">
              <span class="payment-logo visa">VISA</span>
              <span class="payment-logo mc">MC</span>
            </div>

            <p class="payment-info">
              Vos donn√©es personnelles seront utilis√©es pour le traitement de votre commande et le suivi de votre visite sur notre site,
              conform√©ment √† notre
              <a href="politique-confidentialite.html" target="_blank" rel="noopener noreferrer">politique de confidentialit√©</a>.
            </p>
<!-- ‚úÖ Paiement rapide (carte enregistr√©e) -->
<div id="saved-card-block" style="display:none; margin: 10px 0 12px;">
  <div style="
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.35);
    background: rgba(2,6,23,0.75);
  ">
    <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
      <div style="min-width:0;">
        <div style="font-weight:700; font-size:13px; margin-bottom:4px;">
          Paiement plus rapide
        </div>
        <div id="saved-card-summary" style="font-size:12px; color:#9CA3AF;">
          Aucune carte enregistr√©e.
        </div>
      </div>

      <button id="save-card-btn" type="button" style="
        border:none;
        border-radius:999px;
        padding:8px 12px;
        background: linear-gradient(90deg, var(--sb-red), var(--sb-orange));
        color:#fff;
        font-weight:700;
        font-size:12px;
        cursor:pointer;
        white-space:nowrap;
        box-shadow: 0 0 0 1px rgba(248,250,251,0.10), 0 12px 30px rgba(0,0,0,0.7);
      ">
        Enregistrer ma carte
      </button>
    </div>

    <label style="display:flex; gap:10px; align-items:flex-start; margin-top:10px; font-size:12px; cursor:pointer;">
      <input type="checkbox" id="use-saved-card" style="margin-top:2px; width:16px; height:16px; accent-color: var(--sb-red);" />
      <span>
        Payer avec la carte enregistr√©e (1 clic)
        <span style="display:block; font-size:11px; color:#9CA3AF; margin-top:2px;">
          La 3DS peut s‚Äôafficher si n√©cessaire.
        </span>
      </span>
    </label>

    <div id="saved-card-msg" style="font-size:11px; margin-top:6px; min-height:14px; color:#9CA3AF;"></div>
  </div>
</div>
            
            <div class="card-element-wrapper">
              <div id="card-element"></div>
              <div id="card-errors"></div>
            </div>

            <div class="payment-consents">
              <label>
                <input type="checkbox" id="cgv-checkbox">
                <span>
                  J‚Äôai lu et j‚Äôaccepte les
                  <a href="cgv.html" target="_blank" rel="noopener noreferrer">conditions g√©n√©rales de vente</a>.
                </span>
              </label>
              <label>
                <input type="checkbox" id="rules-checkbox">
                <span>Il est interdit de ramener des boissons ou aliments dans les box.</span>
              </label>
              <label>
                <input type="checkbox" id="newsletter-optin">
                <span>Je souhaite recevoir la newsletter Singbox (offres, playlists, soir√©es √† th√®me).</span>
              </label>
            </div>

            <div class="payment-warning">
              <span>‚ö†Ô∏è</span>
              <span>Merci de respecter cette r√®gle pour garantir la propret√© et la s√©curit√© de toutes les box.</span>
            </div>

            <div id="checkout-error" class="checkout-error"></div>
            <div id="checkout-success" class="checkout-success"></div>

            <div class="checkout-submit">
              <button id="checkout-submit-btn" type="button">
                Commander
              </button>
            </div>
          </div>

      <!-- SECTION MERCI / R√âCAPITULATIF POST-PAIEMENT -->
      <div id="thankyou-section">
        <div class="card thankyou-card">
          <div>
            <h2 class="thankyou-title">
              Merci <span id="thankyou-name" class="thankyou-highlight-name"></span> üéâ
            </h2>
            <p class="thankyou-subtitle">
              Votre r√©servation est confirm√©e. Un e-mail r√©capitulatif vient de vous √™tre envoy√© avec tous les d√©tails de votre s√©ance.
            </p>
          </div>

          <div class="thankyou-summary">
            <div>
              <h3 style="font-size:14px;margin-bottom:6px;">D√©tails de votre s√©ance</h3>
              <ul>
                <li><strong>Date :</strong> <span id="thankyou-date">-</span></li>
                <li><strong>Cr√©neau :</strong> <span id="thankyou-time">-</span></li>
                <li><strong>Box :</strong> <span id="thankyou-box">-</span></li>
                <li><strong>Montant pay√© :</strong> <span id="thankyou-total">-</span></li>
                <li><strong>R√©f√©rence r√©servation :</strong> <span id="thankyou-ref">-</span></li>
              </ul>
            </div>
            <div class="thankyou-qr">
              <div class="thankyou-qr-inner">
                <p class="thankyou-qr-label">QR CODE DE R√âSERVATION</p>
                <div class="thankyou-qr-frame">
                  <div id="thankyou-qr"></div>
                  <span id="thankyou-qr-fallback">Disponible bient√¥t</span>
                </div>
                <p class="thankyou-qr-note">
                  Votre QR code de r√©servation est aussi envoy√© par e-mail.<br>
                  Vous pourrez le pr√©senter √† l‚Äôaccueil le jour J.
                </p>
              </div>
            </div>
          </div>

          <div class="thankyou-deposit">
            <strong>√Ä propos de l‚Äôempreinte bancaire de 250‚Ç¨</strong>
            <p>
              Pour garantir le bon d√©roulement de votre s√©ance, une empreinte bancaire de 250‚Ç¨ vient d‚Äô√™tre r√©alis√©e sur votre carte.
              Cette somme n‚Äôest <u>pas d√©bit√©e</u> et ne le sera que :
            </p>
            <ul style="margin:4px 0 0 1.1rem;padding:0;font-size:12px;">
              <li>en cas de d√©gradations importantes dans la box ;</li>
              <li>en cas de non-respect grave du r√®glement int√©rieur ;</li>
              <li>ou si vous ne vous pr√©sentez pas sans pr√©venir selon nos CGV.</li>
            </ul>
            <p style="margin-top:4px;">
              Si tout se passe bien (et on sait que ce sera le cas üòâ), l‚Äôempreinte expirera automatiquement apr√®s la s√©ance.
            </p>
          </div>

          <div class="thankyou-practical">
            <strong>Infos pratiques pour votre venue</strong>
            <ul>
              <li><b>Adresse :</b> Singbox ‚Äì Adresse √† compl√©ter, 31000 Toulouse.</li>
              <li>Vous pouvez arriver d√®s <b>5 minutes avant le d√©but</b> de votre cr√©neau pour vous installer tranquillement.</li>
              <li>En cas de retard, la s√©ance se termine tout de m√™me √† l‚Äôheure pr√©vue afin de respecter les cr√©neaux suivants.</li>
              <li>Merci de pr√©voir une pi√®ce d‚Äôidentit√© au m√™me nom que la r√©servation si besoin de v√©rification.</li>
              <li>Vous retrouverez dans l‚Äôe-mail toutes les informations pratiques (plan d‚Äôacc√®s, parking, r√®glement int√©rieur d√©taill√©).</li>
            </ul>
          </div>

          <div class="thankyou-actions">
            <a href="mon-compte.html" class="thankyou-btn-secondary">Voir mes r√©servations</a>
            <a href="index.html" class="thankyou-btn-primary">Retour √† l‚Äôaccueil</a>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="newsletter-container">
      <h3>Inscrivez-vous √† notre newsletter</h3>
      <p>Des playlists, des infos exclusives, des photos d‚Äôambiance‚Ä¶ Tout arrive bient√¥t.</p>
      <div class="newsletter-row">
        <input
          id="newsletter-email"
          type="email"
          placeholder="Entrez votre adresse e-mail"
        />
        <button
          id="newsletter-submit"
          type="button"
        >
          S'abonner aux actualit√©s
        </button>
      </div>
      <p id="newsletter-message" style="font-size:12px;margin-top:6px;min-height:16px;"></p>
    </div>

    <div class="footer-columns">
      <div class="footer-brand">
        <img src="logo.png" alt="Logo Singbox" />
        <div>
          <p style="font-weight:700;font-size:16px;margin-bottom:4px;">Singbox</p>
          <p style="margin:0;">Karaok√© Box √† Toulouse</p>
        </div>
      </div>

      <div>
        <p><strong>Infos</strong></p>
        <p><a href="mentions-legales.html">Mentions l√©gales</a></p>
        <p><a href="politique-confidentialite.html">Politique de confidentialit√©</a></p>
        <p><a href="cgv.html">CGV</a></p>
      </div>

      <div>
        <p><strong>Contact</strong></p>
        <p>Adresse : [√† compl√©ter]</p>
        <p>Email : contactsingbox@gmail.com</p>
        <p>T√©l√©phone : 06 00 00 00 00</p>
      </div>

      <div>
        <p><strong>R√©seaux</strong></p>

        <p style="display:flex;align-items:center;gap:8px;">
          <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
            <rect x="2" y="2" width="20" height="20" rx="5" fill="none" stroke="#F9FAFB" stroke-width="1.6"/>
            <circle cx="12" cy="12" r="5" fill="none" stroke="#F9FAFB" stroke-width="1.6"/>
            <circle cx="17" cy="7" r="1.2" fill="#F9FAFB"/>
          </svg>
          <a href="https://www.instagram.com/singboxtoulouse/" target="_blank" rel="noopener noreferrer">
            Instagram
          </a>
        </p>

        <p style="display:flex;align-items:center;gap:8px;">
          <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M16 5.5c.7.8 1.6 1.4 2.7 1.6v3a5.1 5.1 0 0 1-3-1v4.3a4.8 4.8 0 1 1-4.7-4.8c.3 0 .6 0 .9.1v3a1.9 1.9 0 1 0 1.4 1.8V4.5h2.7v1z" fill="#F9FAFB"/>
          </svg>
          <a href="https://www.tiktok.com/@singbox.toulouse/" target="_blank" rel="noopener noreferrer">
            TikTok
          </a>
        </p>
      </div>
    </div>

    <div class="footer-bottom">
      R√©alis√© avec ‚ô• pour Singbox
    </div>
  </footer>
  
<script>
  window.API_BASE_URL =
    (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:3000"
      : "https://singbox-backend.onrender.com";

  window.QR_CHECK_BASE_URL = window.API_BASE_URL + "/api/check";
</script>

<!-- Stripe -->
<script src="https://js.stripe.com/v3"></script>
<!-- QR Code library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
  const STRIPE_PUBLISHABLE_KEY = "pk_test_51SYUBK44gpoNdGNgYqQMcppFvT0kViCVEFyDzOQMDz0DR0L71Ob9Kvlh3MO4BFxeRR2bM9VUID7pvrxBoC5GbGSC00Dt8htb3X";
  const PRICE_FALLBACK = 10;

  // ‚úÖ On √©vite les doublons : on reprend les globals d√©j√† d√©finis plus haut
  const API_BASE_URL = window.API_BASE_URL;
  const QR_CHECK_BASE_URL = window.QR_CHECK_BASE_URL;

  // =========================
  // AUTH HELPERS (anti 400 /api/me)
  // =========================
  function getToken() {
    const t = localStorage.getItem("token");
    if (!t || t === "null" || t === "undefined") return null;
    return t;
  }

  function authHeaders(extra = {}) {
    const token = getToken();
    return token ? { ...extra, Authorization: "Bearer " + token } : extra;
  }

  async function handleAuthResponse(res, ctx = "") {
    // ‚úÖ IMPORTANT : on ne supprime PAS le token sur 400
    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem("token");
      console.warn(`[AUTH] Token supprim√© suite √† ${res.status} sur ${ctx || "API"}`);
      return false;
    }
    return true;
  }

  async function apiFetch(path, options = {}, { auth = false, json = true, ctx = "" } = {}) {
    const url = path.startsWith("http") ? path : `${API_BASE_URL}${path}`;

    const headers = options.headers || {};
    const finalHeaders = auth ? authHeaders(headers) : headers;

    const res = await fetch(url, { ...options, headers: finalHeaders });

    if (auth) {
      const okAuth = await handleAuthResponse(res, ctx || path);
      if (!okAuth) return { ok: false, status: res.status, data: null, res };
    }

    if (!json) return { ok: res.ok, status: res.status, data: null, res };

    let data = null;
    try {
      data = await res.json();
    } catch {
      try {
        const txt = await res.clone().text();
        data = { raw: txt };
      } catch {
        data = null;
      }
    }

    if (!res.ok) {
      console.warn(`[API] ${ctx || path} failed:`, res.status, data);
    }

    return { ok: res.ok, status: res.status, data, res };
  }

  let stripe = null;
  let cardElement = null;

  // ‚úÖ NEW : infos carte enregistr√©e
  let savedCardState = {
    enabled: false,
    defaultPaymentMethodId: null,
    card: null,
    methods: []
  };

  let currentPromo = null;
  let loyaltyUsed = false;
  let currentTotals = {
    totalTTCNoDiscount: 0,
    discount: 0,
    finalTotalTTC: 0
  };
  let cartValid = true;

  // ‚úÖ NEW : m√©morise si le client a choisi "payer avec carte enregistr√©e"
  let lastPayWithSaved = false;

  function getPanier() {
    try {
      return JSON.parse(localStorage.getItem("panier")) || [];
    } catch (e) {
      return [];
    }
  }

  function savePanier(panier) {
    localStorage.setItem("panier", JSON.stringify(panier));
  }

  function updateCartIcon() {
    const el = document.getElementById("cart-count");
    if (!el) return;
    const panier = getPanier();
    el.textContent = panier.length ? panier.length : "";
  }

  function computeTotal(panier) {
    let total = 0;
    for (const item of panier) {
      let p = item && typeof item.price === "number" && isFinite(item.price) ? item.price : PRICE_FALLBACK;
      if (!isFinite(p) || p < 0) return null;
      total += p;
    }
    return total;
  }

  function formatDateFr(iso) {
    if (!iso) return "";
    try {
      const [y, m, d] = iso.split("-");
      const date = new Date(parseInt(y, 10), parseInt(m, 10) - 1, parseInt(d, 10));
      return date.toLocaleDateString("fr-FR", {
        weekday: "long",
        day: "2-digit",
        month: "2-digit",
        year: "numeric"
      });
    } catch {
      return iso;
    }
  }

  function getTodayISO() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function isPromoCurrentlyValid(promo) {
    if (!promo) return false;
    if (!promo.is_active) return false;

    const today = getTodayISO();

    if (promo.valid_from && promo.valid_from > today) return false;
    if (promo.valid_to && promo.valid_to < today) return false;

    const maxUses = promo.max_uses;
    const used = promo.used_count || 0;
    if (maxUses !== null && maxUses !== undefined && typeof maxUses === "number") {
      if (used >= maxUses) return false;
    }
    return true;
  }

  function computeDiscountFromPromo(promo, totalTTC) {
    if (!promo || totalTTC <= 0) return 0;
    const value = promo.value || 0;

    if (promo.type === "percent") return Math.min(totalTTC, totalTTC * (value / 100));
    if (promo.type === "fixed") return Math.min(totalTTC, value);
    if (promo.type === "free") return totalTTC;
    return 0;
  }

  function calculateAgeFromBirthdate(isoDate) {
    if (!isoDate) return null;
    const parts = isoDate.split("-");
    if (parts.length !== 3) return null;

    const year = parseInt(parts[0], 10);
    const month = parseInt(parts[1], 10) - 1;
    const day = parseInt(parts[2], 10);

    const birth = new Date(year, month, day);
    if (isNaN(birth.getTime())) return null;

    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    return age;
  }

  function formatTimeFrFromIso(iso) {
    try {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" });
    } catch {
      return "";
    }
  }

  function updateOrderSummaryFromPanier() {
    const panier = getPanier();
    const nameEl = document.getElementById("order-product-name");
    const metaEl = document.getElementById("order-meta");
    const subEl = document.getElementById("order-subtotal");
    const tvaEl = document.getElementById("order-tva");
    const totalEl = document.getElementById("order-total");
    const discountRow = document.getElementById("order-discount-row");
    const discountEl = document.getElementById("order-discount");

    if (!nameEl || !metaEl || !subEl || !tvaEl || !totalEl) return;

    const emptyState = document.getElementById("empty-cart-state");
    const checkoutLayout = document.querySelector(".checkout-layout");
    const paymentCard = document.querySelector(".payment-card");
    const submitBtn = document.getElementById("checkout-submit-btn");

    const setEmptyCartUI = (isEmpty) => {
      if (emptyState) emptyState.style.display = isEmpty ? "block" : "none";
      if (checkoutLayout) checkoutLayout.style.display = isEmpty ? "none" : "grid";
      if (paymentCard) paymentCard.style.display = isEmpty ? "none" : "";
      if (submitBtn) submitBtn.disabled = isEmpty;
    };

    if (panier.length === 0) {
      nameEl.textContent = "Aucune r√©servation";
      metaEl.textContent = "Votre panier est vide. Ajoutez des cr√©neaux depuis la page R√©servation.";
      subEl.textContent = "0‚Ç¨";
      tvaEl.textContent = "0‚Ç¨";
      totalEl.textContent = "0‚Ç¨";
      if (discountRow) discountRow.style.display = "none";
      currentTotals = { totalTTCNoDiscount: 0, discount: 0, finalTotalTTC: 0 };
      cartValid = false;
      setEmptyCartUI(true);
      return;
    }

    const totalTTCNoDiscount = computeTotal(panier);

    if (totalTTCNoDiscount === null) {
      nameEl.textContent = "Erreur sur votre panier";
      metaEl.textContent = "Une erreur s‚Äôest produite sur un des cr√©neaux. Merci de revenir au panier et de recommencer votre s√©lection.";
      subEl.textContent = "‚Äî";
      tvaEl.textContent = "‚Äî";
      totalEl.textContent = "‚Äî";
      if (discountRow) discountRow.style.display = "none";
      currentTotals = { totalTTCNoDiscount: 0, discount: 0, finalTotalTTC: 0 };
      cartValid = false;
      if (submitBtn) submitBtn.disabled = true;
      setEmptyCartUI(false);
      return;
    }

    cartValid = true;
    if (submitBtn) submitBtn.disabled = false;
    setEmptyCartUI(false);

    const totalHTNoDiscount = totalTTCNoDiscount / 1.2;
    const tvaNoDiscount = totalTTCNoDiscount - totalHTNoDiscount;

    let discount = 0;
    if (currentPromo && isPromoCurrentlyValid(currentPromo)) {
      discount = computeDiscountFromPromo(currentPromo, totalTTCNoDiscount);
    } else {
      currentPromo = null;
    }

    if (discount < 0) discount = 0;
    if (discount > totalTTCNoDiscount) discount = totalTTCNoDiscount;

    const discountHT = discount / 1.2;
    const discountTVA = discount - discountHT;

    let totalHT = totalHTNoDiscount - discountHT;
    let tva = tvaNoDiscount - discountTVA;
    let finalTotalTTC = totalTTCNoDiscount - discount;

    if (totalHT < 0) totalHT = 0;
    if (tva < 0) tva = 0;
    if (finalTotalTTC < 0) finalTotalTTC = 0;

    const first = panier[0];
    const dateLabel = first && first.date ? formatDateFr(first.date) : "";
    const boxName =
      first && (first.boxName || first.box || first.boxId)
        ? (first.boxName || first.box || first.boxId)
        : "Box priv√©e";

    let hourText = "";
    if (first && first.start_time && first.end_time) {
      const s = formatTimeFrFromIso(first.start_time);
      const e = formatTimeFrFromIso(first.end_time);
      if (s && e) hourText = `${s} ‚Äì ${e}`;
    } else if (first && typeof first.hour === "number") {
      const start = first.hour;
      const startH = Math.floor(start);
      const startM = Math.round((start - startH) * 60);
      const endMinutes = startH * 60 + startM + 90;
      const endH = Math.floor((endMinutes % 1440) / 60);
      const endM = (endMinutes % 60);

      const startStr = String(startH).padStart(2, "0") + "h" + String(startM).padStart(2, "0");
      const endStr = String(endH).padStart(2, "0") + "h" + String(endM).padStart(2, "0");
      hourText = `${startStr} ‚Äì ${endStr}`;
    }

    const extraCount = panier.length - 1;

    nameEl.textContent =
      extraCount > 0 ? `Box ${boxName} + ${extraCount} autre(s) cr√©neau(x)` : `Box ${boxName}`;

    metaEl.innerHTML =
      (dateLabel ? `Date : ${dateLabel}<br>` : "") +
      (hourText ? `Cr√©neau : ${hourText}<br>` : "") +
      `Nombre de cr√©neaux : ${panier.length}`;

    subEl.textContent = totalHT.toFixed(2).replace(".", ",") + "‚Ç¨";
    tvaEl.textContent = tva.toFixed(2).replace(".", ",") + "‚Ç¨";
    totalEl.textContent = finalTotalTTC.toFixed(2).replace(".", ",") + "‚Ç¨";

    if (discountRow && discountEl) {
      if (discount > 0) {
        discountRow.style.display = "flex";
        discountEl.textContent = "-" + discount.toFixed(2).replace(".", ",") + "‚Ç¨";
      } else {
        discountRow.style.display = "none";
      }
    }

    currentTotals = { totalTTCNoDiscount, discount, finalTotalTTC };
  }

  // =========================
  // ‚úÖ NEW : UI carte enregistr√©e + masquage champ CB
  // =========================
  function setCardElementHidden(hidden) {
    const wrap = document.querySelector(".card-element-wrapper");
    if (!wrap) return;
    wrap.classList.toggle("is-hidden", !!hidden);
  }

  function initSavedCardToggleBehavior() {
    const payToggle = document.getElementById("pay-with-saved-card");
    if (!payToggle) return;

    const sync = () => {
      // on ne masque le champ CB que si :
      // - checkbox coch√©e
      // - et une carte existe r√©ellement (sinon on laisse visible)
      const hasCard = !!(savedCardState.card && savedCardState.card.last4);
      const wantSaved = !!payToggle.checked;

      if (!hasCard) {
        payToggle.checked = false;
        setCardElementHidden(false);
        return;
      }

      setCardElementHidden(wantSaved);
    };

    payToggle.addEventListener("change", sync);
    sync();
  }

  function renderSavedCardUI() {
    const block = document.getElementById("saved-card-block");
    if (!block) return;

    const summary = document.getElementById("saved-card-summary");
    const payToggle = document.getElementById("pay-with-saved-card");
    const saveBtn = document.getElementById("save-card-btn");
    const msg = document.getElementById("save-card-msg");

    const logged = !!getToken();

    if (!logged) {
      block.style.display = "none";
      setCardElementHidden(false);
      return;
    }

    block.style.display = "block";

    const card = savedCardState.card;
    if (summary) {
      if (card && card.last4) {
        summary.textContent = `Carte enregistr√©e : ${card.brand || "carte"} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.last4} (exp. ${card.exp_month}/${card.exp_year})`;
      } else {
        summary.textContent = "Aucune carte enregistr√©e pour le moment.";
      }
    }

    if (payToggle) {
      payToggle.disabled = !(card && card.last4);
      if (payToggle.disabled) payToggle.checked = false;
    }

    if (msg) msg.textContent = "";
    if (saveBtn) saveBtn.disabled = false;

    // ‚úÖ resync masque/affiche champ CB
    initSavedCardToggleBehavior();
  }

  async function loadSavedCardStateFromMe() {
    if (!getToken()) return;

    const r = await apiFetch("/api/me", { method: "GET" }, { auth: true, ctx: "GET /api/me (payment)" });
    if (!r.ok || !r.data) return;

    const payment = r.data.payment || {};
    const card = payment.card || null;

    savedCardState.card = card;
    savedCardState.defaultPaymentMethodId = payment.default_payment_method_id || null;
  }

  async function refreshPaymentMethods() {
    if (!getToken()) return;
    const r = await apiFetch("/api/payment-methods", { method: "GET" }, { auth: true, ctx: "GET /api/payment-methods" });
    if (!r.ok || !r.data) return;

    savedCardState.methods = r.data.methods || [];
    savedCardState.defaultPaymentMethodId = r.data.defaultPaymentMethodId || savedCardState.defaultPaymentMethodId;

    if (!savedCardState.card && savedCardState.defaultPaymentMethodId) {
      const found = savedCardState.methods.find((m) => m.id === savedCardState.defaultPaymentMethodId);
      if (found) savedCardState.card = found;
    }
  }

  async function handleSaveCard() {
    const msg = document.getElementById("save-card-msg");
    const btn = document.getElementById("save-card-btn");
    const payToggle = document.getElementById("pay-with-saved-card");

    if (!getToken()) {
      if (msg) msg.textContent = "Connectez-vous pour enregistrer une carte.";
      return;
    }
    if (!stripe || !cardElement) {
      if (msg) msg.textContent = "Stripe n‚Äôest pas initialis√©.";
      return;
    }

    // ‚úÖ pour enregistrer une carte il faut voir le champ CB
    if (payToggle) payToggle.checked = false;
    setCardElementHidden(false);

    try {
      if (btn) btn.disabled = true;
      if (msg) msg.textContent = "Pr√©paration de l‚Äôenregistrement‚Ä¶";

      const si = await apiFetch("/api/create-setup-intent", { method: "POST" }, { auth: true, ctx: "POST /api/create-setup-intent" });
      if (!si.ok || !si.data || !si.data.clientSecret) {
        if (msg) msg.textContent = "Impossible de pr√©parer l‚Äôenregistrement de la carte.";
        return;
      }

      const setupRes = await stripe.confirmCardSetup(si.data.clientSecret, {
        payment_method: {
          card: cardElement,
          billing_details: {
            name: (document.getElementById("prenom")?.value || "").trim() + " " + (document.getElementById("nom")?.value || "").trim(),
            email: (document.getElementById("email")?.value || "").trim()
          }
        }
      });

      if (setupRes.error) {
        if (msg) msg.textContent = setupRes.error.message || "Erreur lors de l‚Äôenregistrement de la carte.";
        return;
      }

      const paymentMethodId = setupRes.setupIntent && setupRes.setupIntent.payment_method;
      if (!paymentMethodId) {
        if (msg) msg.textContent = "Enregistrement incomplet (payment_method manquant).";
        return;
      }

      if (msg) msg.textContent = "Finalisation‚Ä¶";

      const sd = await apiFetch(
        "/api/set-default-payment-method",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentMethodId })
        },
        { auth: true, ctx: "POST /api/set-default-payment-method" }
      );

      if (!sd.ok) {
        if (msg) msg.textContent = "Carte enregistr√©e, mais impossible de la d√©finir par d√©faut.";
        return;
      }

      savedCardState.card = null;
      await loadSavedCardStateFromMe();
      await refreshPaymentMethods();
      renderSavedCardUI();

      if (msg) msg.textContent = "Carte enregistr√©e ‚úîÔ∏è";
      if (payToggle && !payToggle.disabled) {
        payToggle.checked = true;
        initSavedCardToggleBehavior();
      }
    } catch (e) {
      if (msg) msg.textContent = "Erreur : " + (e?.message || "inconnue");
    } finally {
      if (btn) btn.disabled = false;
    }
  }

  document.addEventListener("DOMContentLoaded", async function () {
    const burgerBtn = document.getElementById("burger-button");
    const mobileNav = document.getElementById("mobile-nav");

    if (burgerBtn && mobileNav) {
      burgerBtn.addEventListener("click", () => mobileNav.classList.toggle("open"));
      mobileNav.addEventListener("click", (e) => {
        if (e.target.tagName === "A") mobileNav.classList.remove("open");
      });
    }

    updateCartIcon();
    updateOrderSummaryFromPanier();

    // =========================
    // SAVE / PREFILL CHECKOUT INFO (localStorage)
    // =========================
    const CHECKOUT_INFO_KEY = "singbox_checkout_info_v1";

    function getCheckoutInfoFromForm() {
      const get = (id) => (document.getElementById(id)?.value || "").trim();
      return {
        prenom: get("prenom"),
        nom: get("nom"),
        pays: document.getElementById("pays")?.value || "FR",
        adresse: get("adresse"),
        complement: get("complement"),
        cp: get("cp"),
        ville: get("ville"),
        telephone: get("telephone"),
        email: get("email"),
        naissance: document.getElementById("naissance")?.value || ""
      };
    }

    function fillCheckoutForm(info) {
      if (!info) return;
      const set = (id, val) => {
        const el = document.getElementById(id);
        if (!el || val === undefined || val === null) return;
        el.value = val;
      };

      set("prenom", info.prenom);
      set("nom", info.nom);
      if (document.getElementById("pays") && info.pays) document.getElementById("pays").value = info.pays;

      set("adresse", info.adresse);
      set("complement", info.complement);
      set("cp", info.cp);
      set("ville", info.ville);
      set("telephone", info.telephone);
      set("email", info.email);
      if (document.getElementById("naissance") && info.naissance) document.getElementById("naissance").value = info.naissance;
    }

    function loadCheckoutInfoLocal() {
      try {
        const raw = localStorage.getItem(CHECKOUT_INFO_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch {
        return null;
      }
    }

    function saveCheckoutInfoLocal(info) {
      try {
        localStorage.setItem(CHECKOUT_INFO_KEY, JSON.stringify(info));
      } catch {}
    }

    let __isPrefilling = false;
    __isPrefilling = true;
    fillCheckoutForm(loadCheckoutInfoLocal());
    __isPrefilling = false;

    async function prefillFromBackendIfLogged() {
      if (!getToken()) return;

      const r = await apiFetch("/api/me", { method: "GET" }, { auth: true, ctx: "GET /api/me (prefill)" });
      if (!r.ok || !r.data) return;

      const data = r.data;
      const p = data.profile || {};

      __isPrefilling = true;

      fillCheckoutForm({
        prenom: p.prenom || "",
        nom: p.nom || "",
        telephone: p.telephone || "",
        pays: p.pays || "FR",
        adresse: p.adresse || "",
        complement: p.complement || "",
        cp: p.cp || "",
        ville: p.ville || "",
        naissance: p.naissance || "",
        email: ""
      });

      if (data.email && document.getElementById("email")) {
        document.getElementById("email").value = data.email;
      }

      __isPrefilling = false;
      saveCheckoutInfoLocal(getCheckoutInfoFromForm());
    }

    await prefillFromBackendIfLogged();

    // =========================
    // ‚úÖ NEW : init carte enregistr√©e
    // =========================
    await loadSavedCardStateFromMe();
    await refreshPaymentMethods();
    renderSavedCardUI();

    const saveCardBtn = document.getElementById("save-card-btn");
    if (saveCardBtn) saveCardBtn.addEventListener("click", handleSaveCard);

    // 2) Autosave local (debounce)
    let _saveTimer = null;
    function scheduleSave() {
      if (__isPrefilling) return;
      clearTimeout(_saveTimer);
      _saveTimer = setTimeout(() => {
        saveCheckoutInfoLocal(getCheckoutInfoFromForm());
      }, 400);
    }

    // ‚úÖ Autosave DB (DEBOUNCE + ANTI-SPAM)
    let _saveDbTimer = null;
    let _lastDbPayload = "";
    async function saveProfileToBackendNow() {
      const token = getToken();
      if (!token) return;

      const payload = getCheckoutInfoFromForm();
      const payloadStr = JSON.stringify(payload);
      if (payloadStr === _lastDbPayload) return;

      const r = await apiFetch(
        "/api/me",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: payloadStr
        },
        { auth: true, ctx: "POST /api/me (autosave)" }
      );

      if (r.ok) _lastDbPayload = payloadStr;
      else console.warn("Autosave profil √©chou√©:", r.status, r.data);
    }

    function saveProfileToBackendDebounced() {
      if (__isPrefilling) return;
      if (!getToken()) return;
      clearTimeout(_saveDbTimer);
      _saveDbTimer = setTimeout(saveProfileToBackendNow, 900);
    }

    [
      "prenom", "nom", "pays", "adresse", "complement", "cp", "ville", "telephone", "email", "naissance"
    ].forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("input", scheduleSave);
      el.addEventListener("change", scheduleSave);

      el.addEventListener("input", saveProfileToBackendDebounced);
      el.addEventListener("change", saveProfileToBackendDebounced);
      el.addEventListener("blur", saveProfileToBackendDebounced);
    });

    /* ----------------------------------------------------------
       PROGRAMME FID√âLIT√â ‚Äî R√âCUP√âRATION + APPLICATION
    ---------------------------------------------------------- */
    async function fetchUserPoints() {
      if (!getToken()) return null;
      const r = await apiFetch("/api/me", { method: "GET" }, { auth: true, ctx: "GET /api/me (points)" });
      if (!r.ok || !r.data) return null;
      return r.data.points ?? 0;
    }

    async function initLoyalty() {
      const loyaltyBlock = document.getElementById("loyalty-block");
      const loyaltyPointsEl = document.getElementById("loyalty-points");
      const useLoyaltyBtn = document.getElementById("use-loyalty-btn");
      const loyaltyMsg = document.getElementById("loyalty-msg");

      if (!loyaltyBlock || !loyaltyPointsEl || !useLoyaltyBtn || !loyaltyMsg) return;

      loyaltyBlock.style.display = "block";

      if (!getToken()) {
        loyaltyPointsEl.textContent = "0";
        loyaltyMsg.style.color = "#FCA5A5";
        loyaltyMsg.textContent = "Connectez-vous √† votre compte pour cumuler et utiliser vos points.";
        useLoyaltyBtn.style.display = "none";
      } else {
        const points = await fetchUserPoints();

        if (points !== null) {
          loyaltyPointsEl.textContent = points;

          if (points >= 100) {
            useLoyaltyBtn.style.display = "block";
            loyaltyMsg.style.color = "#BBF7D0";
            loyaltyMsg.textContent = "Vous pouvez utiliser vos points pour une s√©ance gratuite.";
          } else {
            useLoyaltyBtn.style.display = "none";
            loyaltyMsg.style.color = "#9CA3AF";
            loyaltyMsg.textContent = `Il vous manque encore ${Math.max(0, 100 - points)} point(s) pour une s√©ance gratuite.`;
          }
        } else {
          loyaltyPointsEl.textContent = "0";
          useLoyaltyBtn.style.display = "none";
          loyaltyMsg.style.color = "#FCA5A5";
          loyaltyMsg.textContent = "Impossible de r√©cup√©rer vos points pour le moment.";
        }
      }

      useLoyaltyBtn.addEventListener("click", () => {
        loyaltyMsg.textContent = "";

        if (!getToken()) {
          loyaltyMsg.style.color = "#FCA5A5";
          loyaltyMsg.textContent = "Connectez-vous pour utiliser vos points.";
          return;
        }

        const currentPoints = parseInt(loyaltyPointsEl.textContent || "0", 10);
        if (currentPoints < 100) {
          loyaltyMsg.style.color = "#FCA5A5";
          loyaltyMsg.textContent = "Vous n'avez pas encore assez de points pour une s√©ance gratuite.";
          return;
        }

        currentPromo = { type: "free", code: "LOYALTY100", is_active: true };
        loyaltyUsed = true;
        updateOrderSummaryFromPanier();

        loyaltyMsg.style.color = "#BBF7D0";
        loyaltyMsg.textContent = "üéâ S√©ance gratuite activ√©e. Les points seront d√©bit√©s apr√®s validation du paiement.";
        useLoyaltyBtn.disabled = true;
      });
    }

    await initLoyalty();

    // =========================
    // STRIPE INIT
    // =========================
    if (STRIPE_PUBLISHABLE_KEY && window.Stripe) {
      stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

      const elements = stripe.elements({
        appearance: {
          theme: "night",
          variables: {
            colorPrimary: "#F97316",
            colorBackground: "#020617",
            colorText: "#F9FAFB",
            colorTextSecondary: "#E5E7EB",
            colorTextPlaceholder: "#9CA3AF",
            colorIcon: "#F9FAFB",
            colorDanger: "#FCA5A5",
            borderRadius: "14px"
          }
        }
      });

      cardElement = elements.create("card", { hidePostalCode: true });
      cardElement.mount("#card-element");
      cardElement.on("change", function (event) {
        const displayError = document.getElementById("card-errors");
        if (displayError) displayError.textContent = event.error ? event.error.message : "";
      });
    }

    // =========================
    // PROMO
    // =========================
    const promoToggle = document.getElementById("promo-toggle");
    const promoBody = document.getElementById("promo-body");
    const promoInput = document.getElementById("promo-code");
    const promoBtn = document.getElementById("apply-promo");
    const promoMsg = document.getElementById("promo-message");

    if (promoToggle && promoBody) {
      promoToggle.addEventListener("click", () => promoBody.classList.toggle("open"));
    }

    async function applyPromo(silent = false) {
      if (!promoInput || !promoMsg) return;
      const code = promoInput.value.trim().toUpperCase();
      promoMsg.classList.remove("ok", "error");

      if (!code) {
        currentPromo = null;
        localStorage.removeItem("promoCode");
        updateOrderSummaryFromPanier();
        promoMsg.textContent = silent ? "" : "Saisissez un code promo.";
        if (!silent) promoMsg.classList.add("error");
        return;
      }

      if (!window.supabaseClient) {
        promoMsg.textContent = "Erreur : service promo indisponible.";
        promoMsg.classList.add("error");
        return;
      }

      promoMsg.textContent = "V√©rification du code...";
      try {
        const { data, error } = await window.supabaseClient
          .from("promo_codes")
          .select("*")
          .eq("code", code)
          .limit(1)
          .maybeSingle();

        if (error) {
          currentPromo = null;
          localStorage.removeItem("promoCode");
          updateOrderSummaryFromPanier();
          promoMsg.textContent = "Erreur lors de la v√©rification du code.";
          promoMsg.classList.add("error");
          return;
        }

        if (!data || !isPromoCurrentlyValid(data)) {
          currentPromo = null;
          localStorage.removeItem("promoCode");
          updateOrderSummaryFromPanier();
          promoMsg.textContent = "Ce code n‚Äôexiste pas ou n‚Äôest plus valable.";
          promoMsg.classList.add("error");
          return;
        }

        currentPromo = data;
        localStorage.setItem("promoCode", data.code);
        updateOrderSummaryFromPanier();

        const discountNow = currentTotals.discount || 0;
        promoMsg.classList.add("ok");
        promoMsg.textContent =
          discountNow > 0
            ? "Code appliqu√© ‚úî R√©duction de " + discountNow.toFixed(2).replace(".", ",") + "‚Ç¨ sur votre commande."
            : "Code appliqu√© ‚úî";
      } catch (e) {
        currentPromo = null;
        localStorage.removeItem("promoCode");
        updateOrderSummaryFromPanier();
        promoMsg.textContent = "Erreur r√©seau lors de la v√©rification du code.";
        promoMsg.classList.add("error");
      }
    }

    if (promoBtn) promoBtn.addEventListener("click", () => applyPromo(false));

    if (promoInput) {
      promoInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          applyPromo(false);
        }
      });

      const stored = localStorage.getItem("promoCode");
      if (stored) {
        promoInput.value = stored;
        applyPromo(true);
      }
    }

    // =========================
    // CHECKOUT
    // =========================
    const submitBtn = document.getElementById("checkout-submit-btn");
    const cgvCheckbox = document.getElementById("cgv-checkbox");
    const rulesCheckbox = document.getElementById("rules-checkbox");
    const newsletterCheckbox = document.getElementById("newsletter-optin");
    const errorEl = document.getElementById("checkout-error");
    const successEl = document.getElementById("checkout-success");
    const billingForm = document.getElementById("billing-form");

    const checkoutLayout = document.querySelector(".checkout-layout");
    const thankyouSection = document.getElementById("thankyou-section");
    const thankyouName = document.getElementById("thankyou-name");
    const thankyouDate = document.getElementById("thankyou-date");
    const thankyouTime = document.getElementById("thankyou-time");
    const thankyouBox = document.getElementById("thankyou-box");
    const thankyouTotal = document.getElementById("thankyou-total");
    const thankyouRef = document.getElementById("thankyou-ref");
    const thankyouQrContainer = document.getElementById("thankyou-qr");
    const thankyouQrFallback = document.getElementById("thankyou-qr-fallback");

    const processReservationAndDeposit = async ({ isFree, paymentIntentId }) => {
      const panierBeforeClear = getPanier();
      const firstItem = panierBeforeClear && panierBeforeClear.length > 0 ? panierBeforeClear[0] : null;
      const dateLabel = firstItem && firstItem.date ? formatDateFr(firstItem.date) : "";
      const boxName =
        firstItem && (firstItem.boxName || firstItem.box || firstItem.boxId)
          ? (firstItem.boxName || firstItem.box || firstItem.boxId)
          : "Box priv√©e";

      let hourText = "";
      if (firstItem && firstItem.start_time && firstItem.end_time) {
        const s = formatTimeFrFromIso(firstItem.start_time);
        const e = formatTimeFrFromIso(firstItem.end_time);
        if (s && e) hourText = `${s} ‚Äì ${e}`;
      } else if (firstItem && typeof firstItem.hour === "number") {
        const start = firstItem.hour;
        const startH = Math.floor(start);
        const startM = Math.round((start - startH) * 60);
        const endMinutes = startH * 60 + startM + 90;
        const endH = Math.floor((endMinutes % 1440) / 60);
        const endM = (endMinutes % 60);
        const startStr = String(startH).padStart(2, "0") + "h" + String(startM).padStart(2, "0");
        const endStr = String(endH).padStart(2, "0") + "h" + String(endM).padStart(2, "0");
        hourText = `${startStr} ‚Äì ${endStr}`;
      }

      const prenomValue = document.getElementById("prenom") ? document.getElementById("prenom").value.trim() : "";
      if (thankyouName) thankyouName.textContent = prenomValue;

      if (thankyouDate) thankyouDate.textContent = dateLabel || "-";
      if (thankyouTime) thankyouTime.textContent = hourText || "-";
      if (thankyouBox) thankyouBox.textContent = boxName;
      if (thankyouTotal) {
        const totalLabel = (currentTotals.finalTotalTTC || 0).toFixed(2).replace(".", ",") + "‚Ç¨";
        thankyouTotal.textContent = totalLabel;
      }

      const headerTitle = document.querySelector(".checkout-header h1");
      const headerSubtitle = document.querySelector(".checkout-header p:last-of-type");
      if (headerTitle) headerTitle.textContent = "Merci pour votre r√©servation üéâ";
      if (headerSubtitle) headerSubtitle.textContent = "Voici le r√©capitulatif de votre s√©ance chez Singbox.";

      let reservationId = null;

      try {
        const body = {
          panier: getPanier(),
          customer: {
            prenom: document.getElementById("prenom").value.trim(),
            nom: document.getElementById("nom").value.trim(),
            email: document.getElementById("email").value.trim(),
            telephone: document.getElementById("telephone").value.trim(),
            pays: document.getElementById("pays").value,
            adresse: document.getElementById("adresse").value.trim(),
            complement: document.getElementById("complement").value.trim(),
            cp: document.getElementById("cp").value.trim(),
            ville: document.getElementById("ville").value.trim(),
            naissance: document.getElementById("naissance").value,
            save_checkout_info: true
          },
          promoCode: currentPromo && isPromoCurrentlyValid(currentPromo) ? currentPromo.code : null,
          loyaltyUsed,
          isFree: !!isFree
        };
        if (!isFree && paymentIntentId) body.paymentIntentId = paymentIntentId;

        const confirmRes = await fetch(`${API_BASE_URL}/api/confirm-reservation`, {
          method: "POST",
          headers: authHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify(body)
        });

        const confirmJson = await confirmRes.json().catch(() => ({}));
        if (confirmRes.ok && confirmJson && confirmJson.reservations && confirmJson.reservations.length > 0) {
          reservationId = confirmJson.reservations[0].id;
          if (thankyouRef) thankyouRef.textContent = reservationId;
        } else {
          if (errorEl) {
            errorEl.textContent =
              confirmJson.error ||
              "Votre r√©servation a √©t√© cr√©√©e, mais une erreur interne s‚Äôest produite. Contactez-nous si besoin.";
          }
        }
      } catch (e) {
        console.error("Erreur confirm-reservation :", e);
      }

      // ‚úÖ CAUTION : si lastPayWithSaved = true, on laisse le backend essayer d‚Äôutiliser la carte par d√©faut
      // (si ton backend ne g√®re pas encore useSavedPaymentMethod sur la caution, il peut ignorer et √ßa marchera comme avant)
      try {
        const depositRes = await fetch(`${API_BASE_URL}/api/create-deposit-intent`, {
          method: "POST",
          headers: authHeaders({ "Content-Type": "application/json" }),
          body: JSON.stringify({
            reservationId,
            useSavedPaymentMethod: !!lastPayWithSaved,
            customer: {
              prenom: document.getElementById("prenom").value.trim(),
              nom: document.getElementById("nom").value.trim(),
              email: document.getElementById("email").value.trim()
            }
          })
        });

        const depositJson = await depositRes.json().catch(() => ({}));
        if (depositRes.ok && depositJson && depositJson.clientSecret) {
          // Si le PI de caution est d√©j√† confirm√© c√¥t√© backend (saved card), confirmCardPayment() sans payment_method g√®re 3DS si besoin
          const depositResult = lastPayWithSaved
            ? await stripe.confirmCardPayment(depositJson.clientSecret)
            : await stripe.confirmCardPayment(depositJson.clientSecret, {
                payment_method: {
                  card: cardElement,
                  billing_details: {
                    name: document.getElementById("prenom").value.trim() + " " + document.getElementById("nom").value.trim(),
                    email: document.getElementById("email").value.trim()
                  }
                }
              });

          if (depositResult && depositResult.error) {
            if (errorEl) {
              errorEl.textContent =
                (isFree
                  ? "Votre r√©servation est confirm√©e, mais la caution de 250‚Ç¨ n'a pas pu √™tre pr√©autoris√©e : "
                  : "Votre s√©ance est pay√©e, mais la caution de 250‚Ç¨ n'a pas pu √™tre pr√©autoris√©e : ") +
                depositResult.error.message +
                ". Merci de nous contacter √† contactsingbox@gmail.com.";
            }
          }
        } else {
          if (errorEl) {
            errorEl.textContent =
              (isFree
                ? "Votre r√©servation est confirm√©e, mais la caution de 250‚Ç¨ n'a pas pu √™tre cr√©√©e."
                : "Votre s√©ance est pay√©e, mais la caution de 250‚Ç¨ n'a pas pu √™tre cr√©√©e.") +
              " Merci de nous contacter √† contactsingbox@gmail.com.";
          }
        }
      } catch (e) {
        if (errorEl) {
          errorEl.textContent =
            (isFree
              ? "Votre r√©servation est confirm√©e, mais une erreur est survenue lors de la cr√©ation de la caution."
              : "Votre s√©ance est pay√©e, mais une erreur est survenue lors de la cr√©ation de la caution.") +
            " Merci de nous contacter √† contactsingbox@gmail.com.";
        }
      }

      if (newsletterCheckbox && newsletterCheckbox.checked && window.supabaseClient) {
        try {
          await window.supabaseClient
            .from("newsletter_subscriptions")
            .insert({ email: document.getElementById("email").value.trim() });
        } catch (e) {}
      }

      saveCheckoutInfoLocal(getCheckoutInfoFromForm());

      savePanier([]);
      localStorage.removeItem("promoCode");
      currentPromo = null;
      updateCartIcon();

      const emptyCartState = document.getElementById("empty-cart-state");
      if (emptyCartState) emptyCartState.style.display = "none";

      if (checkoutLayout && thankyouSection) {
        checkoutLayout.style.display = "none";
        thankyouSection.style.display = "block";
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      if (reservationId && thankyouQrContainer && window.QRCode) {
        try {
          const qrText = `${QR_CHECK_BASE_URL}?id=${encodeURIComponent(reservationId)}`;
          thankyouQrContainer.innerHTML = "";
          new QRCode(thankyouQrContainer, {
            text: qrText,
            width: 228,
            height: 228,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
          if (thankyouQrFallback) thankyouQrFallback.style.display = "none";
        } catch (e) {}
      }
    };

    if (submitBtn) {
      submitBtn.addEventListener("click", async () => {
        if (!billingForm) return;
        if (!stripe || !cardElement) {
          if (errorEl) errorEl.textContent = "Erreur de paiement : Stripe n‚Äôest pas initialis√©.";
          return;
        }

        const panier = getPanier();
        if (!panier || panier.length === 0) {
          if (errorEl) errorEl.textContent = "Votre panier est vide. Ajoutez des cr√©neaux depuis la page R√©servation.";
          return;
        }

        if (!cartValid) {
          if (errorEl) errorEl.textContent = "Erreur panier. Revenez au panier et recommencez.";
          return;
        }

        const valid = billingForm.reportValidity();
        if (!valid) {
          if (errorEl) errorEl.textContent = "Merci de compl√©ter tous les champs obligatoires de facturation.";
          return;
        }

        if (!cgvCheckbox || !cgvCheckbox.checked) {
          if (errorEl) errorEl.textContent = "Vous devez accepter les conditions g√©n√©rales de vente pour continuer.";
          return;
        }

        if (!rulesCheckbox || !rulesCheckbox.checked) {
          if (errorEl) errorEl.textContent = "Merci de confirmer que vous respecterez les r√®gles dans les box.";
          return;
        }

        const age = calculateAgeFromBirthdate(document.getElementById("naissance").value);
        if (!age || age < 18) {
          if (errorEl) errorEl.textContent = "La r√©servation doit √™tre faite par un adulte (date de naissance invalide).";
          return;
        }

        if (errorEl) errorEl.textContent = "";
        if (successEl) successEl.textContent = "";

        updateOrderSummaryFromPanier();
        const promoCode = currentPromo && isPromoCurrentlyValid(currentPromo) ? currentPromo.code : null;

        const finalAmountCents =
          currentPromo && currentPromo.type === "free"
            ? 0
            : Math.round((currentTotals.finalTotalTTC || 0) * 100);

        const payWithSaved = !!document.getElementById("pay-with-saved-card")?.checked;
        lastPayWithSaved = payWithSaved;

        // ‚úÖ s√©curit√© : si l‚Äôutilisateur coche mais qu‚Äôil n‚Äôy a pas de carte => on repasse en mode normal
        if (payWithSaved && !(savedCardState.card && savedCardState.card.last4)) {
          lastPayWithSaved = false;
          const t = document.getElementById("pay-with-saved-card");
          if (t) t.checked = false;
          setCardElementHidden(false);
        }

        submitBtn.disabled = true;
        const originalLabel = submitBtn.textContent;
        submitBtn.textContent = "Paiement en cours...";

        try {
          const body = {
            panier,
            customer: {
              prenom: document.getElementById("prenom").value.trim(),
              nom: document.getElementById("nom").value.trim(),
              email: document.getElementById("email").value.trim(),
              telephone: document.getElementById("telephone").value.trim(),
              pays: document.getElementById("pays").value,
              adresse: document.getElementById("adresse").value.trim(),
              complement: document.getElementById("complement").value.trim(),
              cp: document.getElementById("cp").value.trim(),
              ville: document.getElementById("ville").value.trim(),
              naissance: document.getElementById("naissance").value
            },
            promoCode,
            finalAmountCents,
            loyaltyUsed
          };

          if (lastPayWithSaved) {
            body.useSavedPaymentMethod = true;
          }

          const res = await fetch(`${API_BASE_URL}/api/create-payment-intent`, {
            method: "POST",
            headers: authHeaders({ "Content-Type": "application/json" }),
            body: JSON.stringify(body)
          });

          const json = await res.json().catch(() => ({}));

          if (!res.ok) {
            const msg = json.error || "Erreur lors de la cr√©ation du paiement.";
            if (errorEl) errorEl.textContent = msg;
            return;
          }

          if (json.isFree) {
            if (successEl) successEl.textContent = "R√©servation gratuite valid√©e ‚úîÔ∏è";
            await processReservationAndDeposit({ isFree: true, paymentIntentId: null });
            return;
          }

          if (!json.clientSecret) {
            if (errorEl) errorEl.textContent = "R√©ponse inattendue du serveur de paiement.";
            return;
          }

          // ‚úÖ flow saved-card
          if (lastPayWithSaved) {
            if (json.requiresAction) {
              const actionRes = await stripe.confirmCardPayment(json.clientSecret);
              if (actionRes.error) {
                if (errorEl) errorEl.textContent = actionRes.error.message;
                return;
              }
              if (actionRes.paymentIntent && actionRes.paymentIntent.status === "succeeded") {
                if (successEl) successEl.textContent = "Paiement accept√© ‚úîÔ∏è";
                await processReservationAndDeposit({ isFree: false, paymentIntentId: actionRes.paymentIntent.id });
              } else {
                if (errorEl) errorEl.textContent = "Paiement non finalis√©. Merci de r√©essayer.";
              }
            } else {
              const paymentIntentId = json.paymentIntentId || null;
              if (!paymentIntentId) {
                const fallbackRes = await stripe.confirmCardPayment(json.clientSecret);
                if (fallbackRes.error) {
                  if (errorEl) errorEl.textContent = fallbackRes.error.message;
                  return;
                }
                if (fallbackRes.paymentIntent && fallbackRes.paymentIntent.status === "succeeded") {
                  if (successEl) successEl.textContent = "Paiement accept√© ‚úîÔ∏è";
                  await processReservationAndDeposit({ isFree: false, paymentIntentId: fallbackRes.paymentIntent.id });
                } else {
                  if (errorEl) errorEl.textContent = "Paiement non finalis√©. Merci de r√©essayer.";
                }
              } else {
                if (successEl) successEl.textContent = "Paiement accept√© ‚úîÔ∏è";
                await processReservationAndDeposit({ isFree: false, paymentIntentId });
              }
            }
            return;
          }

          // ‚úÖ flow normal
          const result = await stripe.confirmCardPayment(json.clientSecret, {
            payment_method: {
              card: cardElement,
              billing_details: {
                name: document.getElementById("prenom").value.trim() + " " + document.getElementById("nom").value.trim(),
                email: document.getElementById("email").value.trim()
              }
            }
          });

          if (result.error) {
            if (errorEl) errorEl.textContent = result.error.message;
            return;
          }

          if (result.paymentIntent && result.paymentIntent.status === "succeeded") {
            if (successEl) successEl.textContent = "Paiement accept√© ‚úîÔ∏è";
            await processReservationAndDeposit({ isFree: false, paymentIntentId: result.paymentIntent.id });
          }
        } catch (err) {
          if (errorEl) errorEl.textContent = "Erreur inattendue : " + err.message;
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalLabel;
        }
      });
    }
  });
</script>

<!-- POPUP AUTH / FID√âLIT√â JS -->
<script>
  function showAuthModal() {
    const backdrop = document.getElementById("auth-modal-backdrop");
    if (backdrop) backdrop.classList.add("open");
  }

  function hideAuthModal() {
    const backdrop = document.getElementById("auth-modal-backdrop");
    if (backdrop) backdrop.classList.remove("open");
  }

  function initAuthModal() {
    const backdrop = document.getElementById("auth-modal-backdrop");
    if (!backdrop) return;

    const token = localStorage.getItem("token");
    if (!token) showAuthModal();

    const btnLoginTab = document.getElementById("auth-btn-login");
    const btnRegisterTab = document.getElementById("auth-btn-register");
    const loginForm = document.getElementById("auth-login-form");
    const registerForm = document.getElementById("auth-register-form");
    const msgEl = document.getElementById("auth-modal-message");
    const skipBtn = document.getElementById("auth-modal-continue");

    if (btnLoginTab && btnRegisterTab && loginForm && registerForm) {
      btnLoginTab.addEventListener("click", () => {
        btnLoginTab.classList.add("active");
        btnRegisterTab.classList.remove("active");
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
        if (msgEl) msgEl.textContent = "";
      });

      btnRegisterTab.addEventListener("click", () => {
        btnRegisterTab.classList.add("active");
        btnLoginTab.classList.remove("active");
        registerForm.classList.remove("hidden");
        loginForm.classList.add("hidden");
        if (msgEl) msgEl.textContent = "";
      });
    }

    if (skipBtn) skipBtn.addEventListener("click", () => hideAuthModal());

    if (loginForm) {
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (msgEl) msgEl.textContent = "";
        const email = document.getElementById("auth-login-email").value.trim();
        const password = document.getElementById("auth-login-password").value;

        if (!email || !password) {
          if (msgEl) msgEl.textContent = "Merci de renseigner vos identifiants.";
          return;
        }

        try {
          const res = await fetch(`${API_BASE_URL}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            if (msgEl) msgEl.textContent = data.error || "Erreur de connexion.";
            return;
          }

          localStorage.setItem("token", data.token);
          hideAuthModal();
          window.location.reload();
        } catch (err) {
          if (msgEl) msgEl.textContent = "Erreur r√©seau. Veuillez r√©essayer.";
        }
      });
    }

    if (registerForm) {
      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (msgEl) msgEl.textContent = "";
        const email = document.getElementById("auth-register-email").value.trim();
        const password = document.getElementById("auth-register-password").value;

        if (!email || !password) {
          if (msgEl) msgEl.textContent = "Merci de renseigner un email et un mot de passe.";
          return;
        }

        try {
          const res = await fetch(`${API_BASE_URL}/api/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            if (msgEl) msgEl.textContent = data.error || "Erreur lors de la cr√©ation du compte.";
            return;
          }

          const loginRes = await fetch(`${API_BASE_URL}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });

          const loginData = await loginRes.json().catch(() => ({}));
          if (loginRes.ok) {
            localStorage.setItem("token", loginData.token);
            hideAuthModal();
            window.location.reload();
          } else {
            if (msgEl) msgEl.textContent = "Compte cr√©√©, mais la connexion a √©chou√©. Essayez via la connexion.";
          }
        } catch (err) {
          if (msgEl) msgEl.textContent = "Erreur r√©seau. Veuillez r√©essayer.";
        }
      });
    }
  }

  document.addEventListener("DOMContentLoaded", initAuthModal);
</script>

<!-- Supabase Newsletter & client global -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://sfckofydfqbllkxhxwnt.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmY2tvZnlkZnFibGxreGh4d250Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxOTA4ODQsImV4cCI6MjA3OTc2Njg4NH0.2kg7GxQBU8nArCCbJPm0JSn208izXCeiDX266FUC1lw";

  window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  document.addEventListener("DOMContentLoaded", () => {
    const emailInput = document.getElementById("newsletter-email");
    const submitBtn = document.getElementById("newsletter-submit");
    const messageBox = document.getElementById("newsletter-message");

    if (!emailInput || !submitBtn || !messageBox) return;

    submitBtn.addEventListener("click", async () => {
      const email = emailInput.value.trim();

      messageBox.style.color = "#e5e7eb";
      messageBox.textContent = "Envoi en cours...";

      if (!email || !email.includes("@")) {
        messageBox.style.color = "#ff6b6b";
        messageBox.textContent = "Veuillez entrer une adresse e-mail valide.";
        return;
      }

      const { error } = await window.supabaseClient
        .from("newsletter_subscriptions")
        .insert({ email });

      if (error) {
        if (error.code === "23505" || (error.message && error.message.includes("duplicate key value"))) {
          messageBox.style.color = "#38bdf8";
          messageBox.textContent = "Vous √™tes d√©j√† inscrit √† la newsletter üòâ";
        } else {
          messageBox.style.color = "#ff6b6b";
          messageBox.textContent = "Erreur : " + error.message;
        }
      } else {
        messageBox.style.color = "#38bdf8";
        messageBox.textContent = "Merci ! Vous √™tes inscrit üéâ";
        emailInput.value = "";
      }
    });
  });
</script>
</body>
</html>
